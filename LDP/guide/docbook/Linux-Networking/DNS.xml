<sect1 id="DNS">

<title>DNS</title>
	
  Setting Up Your New Domain Mini-HOWTO.

  This document outlines the things you will probably have to do when
  you want to set up a network of computers under your own domain. It
  covers configuration of network parameters, network services, and
  security settings.

  2.  Introduction

  This is a guide to setting up your own domain of Linux machines, or
  mixed Linux and Windows machines, on an always-up connection with a
  static IP and a named domain. It is not really intended for setups
  which use dynamic IPs, or which are regularly disconnected from their
  provider for long periods of time, though some basic hints for
  operating such a setup are available in section ``Using A Dynamic
  IP''.


  With the increasing availability of permanent connections and static
  IPs, it's becoming easier for people and organizations to set up a
  real domain, with the associated Internet presence. Proper planning at
  the outset can reduce problems later.


  Much of this document describes techniques for implementing
  unobtrusive security on the newly exposed network. This deals with
  protection from external attack, and from casual internal attack. It
  does not claim to provide an extremely secure setup, but is usually
  enough to discourage the less determined attacker.


  This document is primarily directed at small organizations which have
  an existing network of computers, possibly with a shared dialup line,
  which are trying to move to a permanent, relatively high-speed
  connection, either to improve data transfer with the outside world, or
  to create a WWW or FTP site. The document is also directed at new
  organizations which want to skip the early stage and start out with
  higher speed networking and services under their own domain name.


  Throughout this document, I will discuss the configuration of a newly
  registered domain, example.com. Note that the name example.com is
  reserved by the Internet Assigned Numbers Authority for use in
  documentation, and so will never correspond to an actual domain.


  Much of the information in this document is available in other places.
  I have tried to distill the material relevant to the creation of a new
  domain. Where detail on a specific subject is lacking, you may want to
  consult one of the more comprehensive documents.


  This document will also assume a mixed OS environment. Specifically, I
  will assume that some desktop machines are running some version of
  Microsoft Windows, while servers and the private network gateway are
  running Linux.



  3.  Planning Your Network Topology

  While there are arguments which can be made for many different network
  layouts, the requirements of many organizations can be met by putting
  the desktop machines and private servers on a private masqueraded
  subnet, and the publicly accessible machines on valid external IPs.
  The machines on valid external IPs will be referred to in this
  document as ``exposed hosts''. This leads to the following (example)
  topology:



       +--------------+
       |              |               +---------------+
       | ISP-supplied |---------------| FTP server    |
       | router       |        |      +---------------+
       |              |        |
       +--------------+        |      +---------------+
                               |------| WWW server #1 |
                               |      +---------------+
                               |
                               |      +---------------+
                               |------| WWW server #2 |
                               |      +---------------+
                               |
                               ~
                               ~
                               |
                               |      +---------------+
                               |------| Private       |
                                      | Network       |
                                      | Gateway       |
                                      +---------------+
                                             |
                                             |
                                             |
                                             |
            +------------+                   |      +-------------------+
            | Desktop #1 |-------------------|------| Private server #1 |
            +------------+                   |      +-------------------+
                                             |
                   .      -------------------|--------        .
                   .                         |                .
                   .      -------------------|--------        .
                                             |
            +------------+                   |      +-------------------+
            | Desktop #N |-------------------|------| Private server #N |
            +------------+                          +-------------------+



  In this example, the router provided by the ISP (Internet Service
  Provider), FTP server, WWW servers, and the machine labelled ``private
  network gateway'' all have externally visible IP numbers, while the
  desktop and private server machines have IP numbers allocated from RFC
  1918 <http://www.ietf.org/rfc/rfc1918.txt>, reserved for private use.
  The IP numbers you choose for use within the private network
  (everything below the private network gateway machine) should be
  chosen to be unique, not only among the hosts under your control, but
  should also not conflict with numbers assigned on similar private
  subnets at other sites or partner companies with whom you might, at
  some time, want to implement a virtual private network, in order to
  reduce confusion and reconfiguration when the networks are merged in
  that way. As outlined in the RFC, you can choose from any class C
  network from 192.168.0.* to 192.168.255.*, or any class B network from
  172.16.*.* to 172.31.*.*, or the class A network 10.*.*.*. In the rest
  of this document I will assume that your private network (if you've
  chosen to create one) is on the class C network 192.168.1.*, and your
  private network gateway machine is at IP number 10.1.1.9, one of the
  IP numbers provided to you by your provider (note that this is not a
  valid external IP, I use it as an example only). I will also assume
  that there is a machine, betty.example.com, at 10.1.1.10, which will
  handle both www and FTP services.


  Take note of the number of external IP numbers which you need for your
  own machines. You will need one IP number for each machine which lies
  outside the private network gateway, plus one for the gateway itself.
  This count does not include any IP numbers which may be taken by
  routers, broadcast addresses, and so on. You should ask your provider
  for a block of addresses large enough to mount the given number of
  machines. For example, in my office network, of the 8 IP numbers
  allocated from the ISP, three were not usable by my computers, leaving
  enough IP numbers for four machines outside the gateway, plus the
  gateway itself.


  This network topology is not correct for everybody, but it is a
  reasonable starting point for many configurations which don't have
  special needs. The advantages of this configuration include:

  ·  Easy expandability. If you suddenly double your number of private
     nodes, you don't have to worry about getting a new IP block from
     your provider and reconfiguring all of the interfaces on your
     machines.

  ·  Local network control. Adding a new workstation to your private
     network requires no communication with your provider, unlike
     exposed nodes, which need both forward and reverse DNS (domain name
     service) mappings if they are to perform certain tasks (ssh and
     ftpd may complain if they can't perform reverse and forward DNS on
     incoming connections). A reverse DNS query is an attempt to obtain
     the host name from the IP number.

  ·  Centralized security. The private network gateway can enforce
     security over the whole private network, filtering packets and
     logging attacks, rather than having to install such measures on
     each desktop and server on the private network. This can be
     enforced not only on incoming packets, but also on outgoing
     packets, so that a misconfigured desktop machine doesn't
     inadvertently broadcast data to the outside world which ought to
     remain internal.

  ·  Easy transplantability. Because the IP numbers within the private
     network are yours for as long as you want them, you can move the
     entire network to a new range of IP numbers without having to make
     any changes to the network configuration on the private network.
     The publicly exposed hosts still have to be reconfigured, of
     course.

  ·  Transparent Internet access. The machines on your private network
     can still use FTP, telnet, WWW, and other services with minimal
     obstruction, assuming a Linux masquerading router. The users may
     not even be aware that their machines are not on externally visible
     IP numbers.


  Some of the potential disadvantages of such a configuration are:


  ·  Some services will not be available directly to the machines on the
     internal network. NTP synchronization against an outside host,
     certain obscure services which may not have masquerading rules in
     the kernel, and .shosts authentication for logging in to external
     nodes are all difficult or impossible, but simple workarounds are
     almost always available.

  ·  More network hardware costs. The private network gateway machine
     needs two network cards, and you need at least two hubs / switches,
     one on the visible network and one on the private network.

  ·  Machines outside the private network cannot easily make direct
     connections to machines within the private network. They may have
     to open a session first on the private network gateway machine,
     then log through to the internal host. It is possible to route
     packets transparently through the firewall, but this is not
     recommended for security reasons which will be discussed in a later
     section.


  You should consider these points in planning your network topology,
  and decide if a fully visible network is more appropriate for your
  situation. In the rest of this document I will assume that you have
  configured your network as shown above. If you have chosen to have a
  fully visible network, some details will differ, and I will try to
  point out such differences in this document.


  As a special case, if you do not need any external servers, the ISP-
  supplied router can be attached directly to your external interface on
  the private network gateway machine, rather than with a hub.



  4.  Obtaining Your Connection


  4.1.  Choosing Your Provider

  As with anything, shop around. Determine which services are available
  in your area, as well as the costs associated with those services. Not
  all locations are wired to accept DSL, and some locations may not be
  suitable for wireless connections due to constraints of the landscape,
  architecture, or environment. Be prepared to provide the street
  address of the location where your hookup will be installed, as DSL
  speeds are strongly dependent on your distance from the switch, and
  ask specifically about such details as bandwidth between your machine
  and the provider, what has to be done to install the connection, and
  what hardware is provided in the quoted monthly rate. Also, you should
  have some idea of how many IP numbers you need for your own machines
  (remember that not all IP numbers in the block you get from the
  provider will be available for attaching your computers).  Ask the
  provider what their total bandwidth is out to the outside world, as
  the quoted speed is only between your site and theirs. If the provider
  has insufficient bandwidth to the outside, the customers will suffer
  bottlenecks within the provider's network.


  Once you have narrowed down a list of candidates, ask around, see if
  anybody can provide you with recommendations for the services you're
  considering. Ask them what sort of bandwidth they get to unloaded
  sites. Also, if you intend to have fast connections between the new
  domain and local ISP accounts from home, for telecommuting, or just
  remote administration, it is essential that you do a traceroute from
  your home ISP account to a host operating on the service you're
  considering. This will tell you how many hops, and how much latency
  you should expect, between home and the new domain. Latencies much
  above 100 to 200 milliseconds can be difficult to use for extended
  periods of time. The traceroute should be run around the time of day
  that you expect to make use of the network connection between home and
  the new domain.



  4.2.  Preparing For Hardware Installation

  After you have chosen the provider and service type for the new
  domain, ask about installation details. You may require service calls
  from the telephone company as well as from the ISP in order to install
  the service, and the technicians may need access to controlled areas
  of your building, so inform the building engineer of the installation
  requirements.


  Before the ISP technician arrives, ask for the network parameters,
  specifically the IP number, netmask, broadcast address, gateway
  routing address, DNS server address, and also what cabling you need to
  connect to the hardware delivered by the technician (i.e. straight-
  through or crossover RJ45 cabling, etc.).


  Have one machine available for testing, and put it close to where the
  network connection hardware will be installed. If possible, configure
  it before the service technician arrives, setting the IP number and
  netmask, and have the appropriate cabling ready so that the
  installation and testing can be done quickly.



  4.3.  Testing The Connection

  With your test machine attached to the ISP's hardware, make sure that
  you can ping sites beyond the ISP. If not, a traceroute to the outside
  can help to show where the connection is failing. If traceroute shows
  no successful hops it indicates that your test machine's network
  configuration (default route, interface address, NIC drivers, DNS,
  etc.) is incorrectly set. If it shows one hop, that could mean that
  your router is not correctly configured to communicate with the ISP.
  If it shows several hops before failing, the problem is almost
  certainly in the ISP or in the outside world, and beyond your
  immediate control.



  4.4.  Using A Dynamic IP

  The benefits of a corporate connection, with a static IP block and
  various hosted services, comes with a cost. It can be more than ten
  times as expensive as a high speed home connection on DSL or cable
  modem. If the budget can't support a corporate connection, or if no
  such connections are available in your area, you might want to try to
  set up a domain on a dynamic IP. Instead of a range of IP numbers, you
  typically get exactly one, which means that your private network
  gateway machine will also have to host any incoming services from the
  outside.


  First, you might want to check the legality of it. Many companies'
  user agreements explicitly forbid setting up externally-accessible
  servers on personal accounts. They may enforce this with packet
  filters blocking incoming connections on the http and FTP ports. You
  should also be aware that the quoted connection speed for personal
  accounts such as home DSL or cable modem are the downlink speeds, and
  that the uplink speeds might be much slower. The uplink speed is what
  is important for serving up FTP or web content.


  If you have a dynamic IP, and you want to have incoming connections,
  you will have to subscribe to a dynamic IP hosting service, such as
  one of those listed at Dynamic DNS Providers
  <http://www.technopagan.org/dynamic/>. These services typically work
  by running software on your machine which passes your current IP
  number on to the company's servers. When your current IP number
  arrives at the servers, their DNS tables are updated to reflect the
  new value. You can either get a domain name under their domain name,
  such as ``example.dynip.com'' or ``example.dynhost.com'', or you can
  register your own domain and set the primary DNS authority to point to
  the company providing this service (usually at a higher cost).


  There is also a free hosting service, at Domain Host Services
  <http://www.dhs.org/>. They seem fairly new, and there are few details
  on their web site at the moment, but you might find it worth a look.


  If you have set up a dynamic IP, and subscribed to one of these
  services, it will affect some of the decisions you make in section
  ``Deciding Which Domain Services You Will Host''. In particular, there
  is little point subscribing to a dynamic IP hosting service if you do
  not plan to host at least one of web or FTP services. You will have to
  set primary DNS authority to point to the company you've chosen. You
  should not have a named daemon answering requests from outside your
  private network. Other details, such as handling of email, will depend
  on the specifics of the service you've subscribed to, and can best be
  answered by the support staff of that company.


  One final note: if you want to have remote access to a machine with a
  dynamic IP, but don't need it for hosting other services, the
  inexpensive solution is to create a ``drop box'' on a publicly
  accessible machine with a static IP, and have your dynamic IP host
  send its IP number there, either in email or simply by writing it into
  a file on a shell account. When you want to access your machine
  remotely, first extract the current IP number from the drop box, then
  use slogin to attach directly to that IP number. This is, after all,
  really all that a dynamic IP hosting service does, they just do it
  automatically over standard services, saving you some steps.



  5.  Registering A Domain Name

  In order for people in the outside world to locate your servers under
  the domain name of your choice, whether for web, FTP, or email
  delivery, you will have to register the domain name for insertion into
  the relevant top level domain database.


  Exercise some simple prudence in choosing your domain name. Certain
  words or phrases may be forbidden on the grounds of community
  standards, or may be offensive to visitors whose language or slang
  differs from that of your region. Domain names can contain only the 26
  letters of the Roman alphabet (without accents), the hyphen (though
  not at the beginning or end of the name), and the 10 digits. Domain
  names are not case-sensitive, and can be at least 26 characters long
  (this limit is subject to change). Be careful not to register a name
  which you can reasonably have been expected to know infringes on the
  trademarks of an existing company, the courts are not kind to
  cybersquatters. Some information on the circumstances under which your
  poorly-chosen domain name might be stripped from your control are
  available in this Uniform Domain Name Dispute Resolution Policy
  <http://www.icann.org/udrp/udrp-policy-24oct99.htm>.


  There are many companies which register names in the ``.com'',
  ``.net'', and ``.org'' top level domains. For a current list, check
  the list of accredited registrars
  <http://www.icann.org/registrars/accredited-list.html>.


  To register a name under a country top level domain, such as a
  ``.ca'', ``.de'', ``.uk'', etc., check with the appropriate authority,
  which can be located in the Country Code Top-Level Domains database
  <http://www.iana.org/cctld.html>.


  Typically, you have to provide the registrar with contact information,
  primary and secondary DNS IP numbers, a change request validation
  scheme (you wouldn't want just anybody changing your domain for you),
  and money in the form of an annual fee. If you're not comfortable with
  the change request validation schemes offered by a registrar, let them
  know that you're not willing to use the service until they address
  your security concerns.



  6.  Deciding Which Domain Services You Will Host

  Most full-service ISPs will provide a variety of domain services for
  their customers. This is largely because of the problems associated
  with hosting these services under certain other, more popular desktop
  and server operating systems. These services are much easier to
  provide under Linux, and can be hosted on fairly inexpensive hardware,
  so you should decide what services you want to take on for yourself.
  Some of these services include:

  ·  Primary DNS authority on your domain. See section ``Primary DNS
     Authority''.

  ·  Electronic mail. See section ``Electronic Mail''.

  ·  Web space hosting. See section ``Web Space Hosting''.

  ·  FTP space hosting. See section ``FTP Site Hosting''.

  ·  Packet filtering. See section ``Packet Filtering''.

  In each of these, you basically have to weigh convenience against
  control. When your ISP performs one or more of these services, you can
  usually be fairly sure that they have people with experience
  maintaining the service, so you have less to learn, and less to worry
  about. At the same time, you lose control over these services. Any
  changes require that you go through the technical support of your ISP,
  something which may sometimes be inconvenient or cause longer delays
  than you would like. There's also a security issue involved, the ISP
  is a much more tempting target to attackers than your own site. Since
  an ISP's servers might host email and/or web space for the dozens of
  companies which are their customers, an attacker who compromises one
  of those servers gets a much higher return for his efforts than one
  who attacks your personal servers, where only one company's data is
  kept.



  6.1.  Primary DNS Authority

  When a person somewhere in the outside world attempts to connect to a
  machine in the new example.com domain, queries are sent between
  various servers on the Internet, ultimately resulting in the IP number
  of that machine being returned to the software of the person
  attempting the connection. The details of this sequence are beyond the
  scope of this document. Neglecting many details, when a request is
  made for the machine fred.example.com, a centralized database is
  consulted to determine what is the IP number of the machine which
  holds primary DNS authority for the example.com domain. This IP number
  is then queried for the IP number of the machine fred.example.com.


  There must be a primary and a secondary DNS server for every domain
  name. The names and IP numbers of these two servers are stored in a
  centralized database whose entries are controlled by domain
  registration authorities such as Network Solutions
  <http://www.networksolutions.com/>.


  If you elect to have primary DNS authority hosted by your ISP, these
  two servers will probably both be machines controlled by the ISP. Any
  time you want to add an externally visible machine to your network,
  you will have to contact the ISP and ask them to put the new machine
  in their database.


  If you elect to hold primary DNS authority on your own host, you will
  still use another machine as your secondary. Technically, you should
  use one on a redundant Internet connection, but it is very common that
  the secondary is held on one of your ISP's machines. If you want to
  add an externally visible machine to your network, you will have to
  update your own database, and then wait for the change to propagate
  (something which takes, typically, a small number of hours). This
  allows you to add barney.example.com without having to go through your
  ISP.


  It is a good idea to set up secondary DNS on a geographically distant
  host, so that a single cable cut near your ISP doesn't take both your
  primary and secondary DNS servers off line. The domain registrar you
  used to register your domain name may provide secondary DNS service.
  There is also a free service, Granite Canyon
  <http://www.granitecanyon.com/>, available to anybody who asks.


  Regardless of whether or not you choose to act as primary DNS
  authority for your domain, see section ``Setting Up Name Resolution''
  for configuration help. You will want some sort of name resolution
  system for your private network, even if you delegate primary DNS
  authority to the ISP.



  6.2.  Electronic Mail

  When you subscribe with your ISP, they will typically supply a number
  of email boxes. You can elect to use this service exclusively, in
  which case all incoming email is stored on the ISP's servers and your
  users read their mail with POP3 clients which connect to the ISP's
  servers. Alternately, you may decide to set up email on your own
  machines. Once again, you should weigh the merits of the two
  approaches, and choose the one which you prefer.


  Things to remember if you use the ISP for all email:

  ·  It may be easier to access the email from home, or from other
     locations when you're on a business trip, depending on the security
     which you use to protect your domain.

  ·  Email is routinely stored on the ISP's servers, which may be a
     problem if sensitive material is sent unencrypted.

  ·  You have a limited number of email accounts, and may have to pay if
     you exceed this limit.

  ·  To create a new email address, you have to go through the ISP.


  Things to remember if you provide your own email:

  ·  Email is routinely stored on your own servers, with backup storage
     on your ISP if your mail host goes down or its disk fills up.

  ·  You have an essentially unlimited number of email accounts, which
     you can create and delete yourself.

  ·  You have to support the email clients used on your private network,
     and possibly by people trying to read their email from home.


  One possible approach is to host email yourself, but also use the
  several email addresses provided by the ISP. People who need email
  accessible from outside the private network can have an email address
  in your domain which gets redirected to one of the ISP-supplied email
  addresses. Others can have local email on the private network. This
  requires a bit more coordination and configuration, but gives more
  flexibility than either of the other approaches.


  Should you choose to host email for your domain, see section ``Setting
  Up Email For Your Domain'' for configuration help.


  If you decide not to host email for your domain, refer to section
  ``DNS Configuration If You Are Not Hosting Email'' for important notes
  on the name resolution configuration.



  6.3.  Web Space Hosting

  Your ISP may allocate you a certain amount of space on their web
  servers. You might decide to use that, or you might have a web hosting
  machine which you put on your external network, in one of your
  external IP numbers.


  Points to remember if you choose to use the ISP's web space hosting:

  ·  You have a certain disk space allocation which you should not
     exceed. This will include not only web space contents, but also
     data collected from people visiting the site.

  ·  The bandwidth between your web server and the outside world will
     almost certainly be higher than it would be if you hosted it on
     your own hardware. In any case, it will not be slower.

  ·  It may be difficult to install custom CGI scripts or commercial
     packages on your web site.
  ·  Your bandwidth between your network and your web server will almost
     certainly be lower than it would be if you hosted it on your own
     network.


  Points to remember if you choose to host your own web space:

  ·  You have much more control over the hosting machine. You can tailor
     your security more precisely for your application.

  ·  Potentially sensitive data, such as credit card numbers or mailing
     addresses, remains on machines which you control.

  ·  Your backup strategy is probably not as comprehensive as your
     ISP's.


  Notice that I do not mention anything about the ISP having more
  powerful hardware, higher peak data rates, and so on. By the time
  these things become important, you're talking about very high data
  rate network connections, and, quite frankly, you had better be
  delegating these decisions to a skilled consultant, not looking in a
  Linux HOWTO.


  Should you choose to host web space for your domain on your own
  server(s), refer to other documents, such as the WWW-HOWTO
  <ftp://metalab.unc.edu/pub/Linux/docs/HOWTO/WWW-HOWTO>, for
  configuration help. I strongly recommend that this service be run on a
  different machine from the private network gateway machine, for
  security reasons.



  6.4.  FTP Site Hosting

  Basically, the same arguments apply to FTP hosting as apply to WWW
  hosting, with the exception that active content is not an issue for
  FTP, and CGI scripts don't appear. Most of the recent ftpd exploits
  have come from buffer overruns resulting from the creation of large
  directory names in anonymously-writable upload directories, so if your
  ISP allows uploads and is lax in keeping up with security updates on
  the FTP daemon, you might be better off hosting this service yourself.


  Should you choose to host FTP for your domain on your own server(s),
  make sure to get the latest version of your FTP daemon, and consult
  the configuration instructions there. Once more, I strongly recommend
  that this service be run on a different machine from the private
  network gateway machine, for security reasons.


  For wu-ftpd, I would recommend the following configuration options:

  ·  --disable-upload - unless you need anonymous uploads

  ·  --enable-anononly - encourage your local users to use scp to
     transfer files between machines.

  ·  --enable-paranoid - disable whatever features of the current
     release might be considered questionable.



  6.5.  Packet Filtering

  Some ISPs will put packet filters on their network, to protect the
  users of the system from each other, or from external attackers. Cable
  modem networks and similar broadcast networks have had embarrassing
  problems when users of Windows 95 or 98 inadvertently set up disk
  shares, exporting the full contents of their hard drives to anybody on
  the network segment who cared to browse for active servers in the
  neighbourhood.  In some cases, the solution has been to tell the users
  not to do that, but some providers have put filtering into the access
  hardware to prevent people from exporting their data by accident.


  Packet filtering is really something which you ought to do yourself.
  It fits in easily into the kernel running on your private network
  gateway machine and gives you a better idea of what's happening around
  you. You often will find that you have to make small tweaks to the
  firewall to optimize it during the initial setup, and this is much
  easier to do in real time than through a technical support contact.


  Should you choose to do packet filtering for your domain, see section
  ``Setting Up Packet Filtering'' for configuration help.



  7.  Configuring Your Hosted Services

  7.1.  Setting up Name Resolution

  You will want some way for the computers on your network to refer to
  one another by name, and also a way for people in the outside world to
  refer to your exposed hosts by name. There are several ways to go
  about doing this.


  7.1.1.  DNS On Private Network, ISP Handles Domain

  [ Note: if you have chosen not to implement a private network, go to
  section ``Fully Exposed Network, Hosted By ISP''. ]


  In this configuration, you have delegated responsibility for the
  primary DNS authority on your domain to the ISP. You still use DNS
  within your private network when hosts there want to talk to one
  another. You have given your ISP a list of the names and IP numbers of
  all exposed hosts. If you want one externally visible machine, for
  instance betty.example.com, to act both as web and FTP server, you
  should ask the ISP to make CNAME entries for www.example.com and
  ftp.example.com pointing to betty.example.com.


  Set up DNS on your private network gateway machine. This can be done
  securely, and makes upgrading easier, should you later decide to host
  primary DNS authority for your domain.


  I will assume that you have decided to host DNS from the machine
  dns.example.com, which is on the private network gateway, and an alias
  for fred.example.com at 192.168.1.1. Some small modifications have to
  be made to this configuration if this is not the case. I will not
  cover that in this HOWTO unless there is significant interest.



  You will have to download and compile a recent version of BIND, the
  Berkeley Internet Name Domain. It is available at the BIND web site
  <http://www.isc.org/products/BIND/>. Next, you have to configure the
  daemon.  Create the following file, /etc/named.conf:


       ______________________________________________________________________
       options {
               directory "/var/named";
               listen-on { 192.168.1.1 };
       };

       zone "." {
               type hint;
               file "root.hints";
       };

       zone "0.0.127.in-addr.arpa" {
               type master;
               file "pz/127.0.0";
       };


       zone "1.168.192.in-addr.arpa" {
               type master;
               file "pz/1.168.192";
       };

       zone "example.com" {
               type master;
               notify no;
               file "pz/example.com";
       };
       ______________________________________________________________________



  Note that we are declaring ourselves the master for the example.com
  domain. Meanwhile, our ISP is also declaring itself to be the master
  for the same domain. This is not a problem, as long as you are careful
  about the setup. All of the machines on the private network must use
  dns.example.com to perform their name resolution. They must not use
  the name resolvers of the ISP, as the ISP name server believes itself
  to be authoritative over your entire domain, but it doesn't know the
  IP numbers or names of any machines on your private network.
  Similarly, hosts on exposed IP numbers in your domain must use the ISP
  name server, not the private name server on dns.example.com.


  The various files under /var/named must now be created.


  The root.hints file is exactly as described in the BIND documentation,
  or in the DNS HOWTO <ftp://metalab.unc.edu/pub/Linux/docs/HOWTO/DNS-
  HOWTO>. At the time of this writing, the following is a valid
  root.hints file:



  ______________________________________________________________________
  H.ROOT-SERVERS.NET.     6d15h26m24s IN A  128.63.2.53
  C.ROOT-SERVERS.NET.     6d15h26m24s IN A  192.33.4.12
  G.ROOT-SERVERS.NET.     6d15h26m24s IN A  192.112.36.4
  F.ROOT-SERVERS.NET.     6d15h26m24s IN A  192.5.5.241
  B.ROOT-SERVERS.NET.     6d15h26m24s IN A  128.9.0.107
  J.ROOT-SERVERS.NET.     6d15h26m24s IN A  198.41.0.10
  K.ROOT-SERVERS.NET.     6d15h26m24s IN A  193.0.14.129
  L.ROOT-SERVERS.NET.     6d15h26m24s IN A  198.32.64.12
  M.ROOT-SERVERS.NET.     6d15h26m24s IN A  202.12.27.33
  I.ROOT-SERVERS.NET.     6d15h26m24s IN A  192.36.148.17
  E.ROOT-SERVERS.NET.     6d15h26m24s IN A  192.203.230.10
  D.ROOT-SERVERS.NET.     6d15h26m24s IN A  128.8.10.90
  A.ROOT-SERVERS.NET.     6d15h26m24s IN A  198.41.0.4
  ______________________________________________________________________



  The pz/127.0.0 file is as follows:


       ______________________________________________________________________
       $TTL 86400

       @               IN      SOA     example.com. root.example.com. (
                                       1       ; Serial
                                       8H      ; Refresh
                                       2H      ; Retry
                                       1W      ; Expire
                                       1D)     ; Minimum TTL
                               NS      dns.example.com.
       1                       PTR     localhost.
       ______________________________________________________________________



  The pz/1.168.192 file is as follows:


       ______________________________________________________________________
       $TTL 86400

       @       IN      SOA             dns.example.com. root.dns.example.com. (
                                       1       ; Serial
                                       8H      ; Refresh 8 hours
                                       2H      ; Retry   2 hours
                                       1W      ; Expire  1 week
                                       1D      ; Minimum 1 day
                               )
                       NS      dns.example.com.

       1               PTR     fred.example.com.
                       PTR     dns.example.com.
                       PTR     mail.example.com.
       2               PTR     barney.example.com.
       3               PTR     wilma.example.com.
       ______________________________________________________________________



  and so on, where you create one PTR record for each machine with an
  interface on the private network. In this example, fred.example.com is
  on IP number 192.168.1.1, and is pointed to by the dns.example.com and
  mail.example.com aliases. The machine barney.example.com is on IP num­
  ber 192.168.1.2, and so on.


  The pz/example.com file is as follows:


       ______________________________________________________________________
       $TTL 86400

       @               IN      SOA     example.com. root.dns.example.com. (
                                       1       ; Serial
                                       8H      ; Refresh 8 hours
                                       2H      ; Retry   2 hours
                                       1W      ; Expire  1 week
                                       1D      ; Minimum 1 day
                               )
                               NS              dns.example.com.
               IN              A               192.168.1.1
               IN              MX          10  mail.example.com.
               IN              MX          20  <ISP mail machine IP>.


       localhost               A           127.0.0.1
       fred                    A           192.168.1.1
                               A           10.1.1.9
       dns                     CNAME       fred
       mail                    CNAME       fred
       barney                  A           192.168.1.2
       wilma                   A           192.168.1.3
       betty                   A           10.1.1.10
       www                     CNAME       betty
       ftp                     CNAME       betty
       ______________________________________________________________________



  Note that we create entries for machines both within the private net­
  work and on external IPs, since machines within the private network
  will not query the ISP's name servers for a request on, say,
  betty.example.com. We also provide both IP numbers for fred, the pri­
  vate and external IP numbers.


  One line in the ``options'' section of /etc/named.conf bears
  discussion:


       listen-on { 192.168.1.1 };



  This will prevent your named daemon from answering DNS requests on the
  outside interface (all requests from the outside must go through the
  ISP's name resolver, not yours).



  7.1.2.  Non-DNS Resolution On Private Network, ISP Handles Domain

  [ Note: if you have chosen not to implement a private network, go to
  section ``Fully Exposed Network, Hosted By ISP''. ]
  In this configuration, you have decided that your private network is
  fairly small and unlikely to change often. You have decided not to use
  the centralized database of a DNS server, and instead to maintain the
  host resolution separately on each machine. All machines should use
  the ISP's DNS server for their host name resolution for machines
  beyond the private network gateway. For name resolution on the private
  network, a hosts table has to be created. For Linux, this means
  entering the names and IP numbers of all of the machines on the
  private network into the /etc/hosts on each machine. Any time a new
  machine is added, or a name or IP number is changed, this file has to
  be updated on each Linux box.


  As in section ``DNS Resolution on Private Network, ISP Handles
  Domain'', the list of host names on exposed IP numbers must be sent to
  the ISP, and any aliases (such as for www and ftp names) should be
  specified so that a CNAME entry can be created by the ISP.



  7.1.3.  You Are Primary DNS Authority For Domain

  While you could set up named resolution on the exposed hosts, and
  private database resolution for the private network, I will not cover
  that case. If you're going to be running named for one service, you
  ought really to do it for both, just to simplify the configuration. In
  this section I will assume that the private network gateway machine is
  handling name resolution both for the private network and for outside
  requests.


  At the time of this writing, under version 8.2.2 of the BIND package,
  there is no way for a single named daemon to produce different answers
  to requests, depending on which interface the request arrives on. We
  want name resolution to act differently if the query comes from the
  outside world, because IP numbers on the private network shouldn't be
  sent out, but have to be available in answer to requests from within
  the private network. There is some discussion of a new ``views''
  keyword which may be added to BIND to fill this need at a later date,
  but until that happens, the solution is to run two named daemons with
  different configurations.


  First, set up the private network domain name server as described in
  section ``DNS Resolution on Private Network, ISP Handles Domain''.
  This will be the name resolver visible from within your private
  network.


  Next, you have to set up DNS for your domain, as visible to hosts in
  the outside world. First, check with your provider to see if they will
  delegate reverse lookups of your IP numbers to them. While the
  original DNS standard didn't account for the possibility of
  controlling reverse DNS on subnets smaller than a class C network, a
  workaround has been developed which works with all compliant DNS
  clients, and has been outlined in RFC 2317
  <http://www.ietf.org/rfc/rfc2317.txt>. If your provider is willing to
  delegate control of reverse DNS on your IP block, you will have to
  determine from them the exact name of the in-addr pseudo-domain they
  have chosen to delegate to (the RFC does not offer a convention they
  recommend for everyday use), and you will have to register control for
  that pseudo-domain. I will assume that the provider has delegated
  control to you, and the name of the pseudo-domain is 8.1.1.10.in-
  addr.arpa. The provider would create CNAME entries of the form


  8.1.1.10.in-addr.arpa.     2H IN CNAME 8.8.1.1.10.in-addr.arpa.
  9.1.1.10.in-addr.arpa.     2H IN CNAME 9.8.1.1.10.in-addr.arpa.
  10.1.1.10.in-addr.arpa.    2H IN CNAME 10.8.1.1.10.in-addr.arpa.
  etc.



  in their zone file for the 1.1.10.in-addr.arpa domain. The configura­
  tion of your 8.1.1.10.in-addr.arpa zone file is given later in this
  section.


  If your provider is willing to delegate control of the reverse DNS to
  you, they will create CNAME entries in their reverse DNS zone table
  for those IP numbers you control, pointing to the corresponding
  records in your pseudo-domain, as shown above. If they are not willing
  to delegate control to you, you will have to ask them to update their
  reverse DNS entries any time you add, delete, or change the name of an
  externally visible host in your domain. If the reverse DNS table is
  not synchronized with your forward DNS entries, certain services may
  generate warnings, or refuse to handle requests issued by machines
  affected by the mismatch.


  You now have to create a second named setup, this one to handle
  requests issued by machines outside the private network gateway. This
  setup lists only those hosts and IP numbers which are externally
  visible, and responds only to requests on the outside interface of the
  private network gateway machine.


  First, create a second configuration file, for instance
  /etc/named.ext.conf for requests from the external interface. In our
  example, it might be as follows:


       ______________________________________________________________________
       options {
               directory "/var/named";
               listen-on { 10.1.1.9; };
       };

       zone "." {
               type hint;
               file "root.hints";
       };

       zone "0.0.127.in-addr.arpa" {
               type master;
               file "pz/127.0.0";
       };


       zone "8.1.1.10.in-addr.arpa" {
               type master;
               file "ext/8.1.1.10";
       };

       zone "example.com" {
               type master;
               notify no;
               file "ext/example.com";
       };
       ______________________________________________________________________

  The root.hints and pz/127.0.0 files, both under /var/named are shared
  with the other running daemon. The file ext/8.1.1.10 is as follows:


       ______________________________________________________________________
       $TTL 86400

       @       IN      SOA             fred.example.com. root.fred.example.com. (
                                       1               ; Serial
                                       10800           ; Refresh       3 hours
                                       3600            ; Retry         1 hour
                                       3600000         ; Expire        1000 hours
                                       86400 )         ; Minimum       24 hours
                       NS      dns.example.com.
       9       IN      PTR     fred.example.com.
                       PTR     dns.example.com.
                       PTR     mail.example.com.
       10      IN      PTR     betty.example.com.
                       PTR     www.example.com.
                       PTR     ftp.example.com.
       ______________________________________________________________________



  The file ext/example.com contains the following:


       ______________________________________________________________________

       $TTL 86400

       @               IN      SOA     example.com. root.fred.example.com. (
                                       10021   ; Serial
                                       8H      ; Refresh 8 hours
                                       2H      ; Retry   2 hours
                                       1W      ; Expire  1 week
                                       1D      ; Minimum 1 day
                               )
                               NS              fred.example.com.
               IN              A               10.1.1.9
               IN              MX          10  mail.example.com.
               IN              MX          20  <ISP Mail Machine>.


       localhost               A           127.0.0.1
       fred                    A           10.1.1.9
       betty                   A           10.1.1.10
       dns                     CNAME       fred
       mail                    CNAME       fred
       www                     CNAME       betty
       ftp                     CNAME       betty
       ______________________________________________________________________



  Start the two daemons on the private network gateway machine. Put the
  following into your network daemon initialization scripts:


       /usr/sbin/named -u dnsuser -g dnsgroup /etc/named.conf
       /usr/sbin/named -u dnsuser -g dnsgroup /etc/named.ext.conf

  I've assumed here that you have created the unprivileged user
  ``dnsuser, and the corresponding unprivileged group ``dnsgroup''. If a
  bug in bind turns up, which allows an attacker to execute code from
  within named, the attacker will find himself restricted to those oper­
  ations available to the unprivileged user. The /var/named directory
  and the files within should not be writable by ``dnsuser''.


  The machines on the private network must have their name resolution
  configured to ask dns.example.com (at IP 192.168.1.1 in our example),
  while the externally visible machines can either query the network
  gateway's outside interface (at IP 10.1.1.9 in our example), or the
  ISP's DNS servers.



  7.1.4.  Fully Exposed Network, Hosted By ISP

  In this configuration, you have chosen to expose all of your hosts.
  You have a real IP number for each machine in your domain, and you've
  given your ISP the list of machine names and IP numbers. The ISP has
  given you at least one IP number for their DNS host(s). Your Linux
  boxes are now configured for name resolution in /etc/resolv.conf:


       ______________________________________________________________________
       search example.com
       nameserver <DNS host 1>
       nameserver <DNS host 2>
       ______________________________________________________________________



  Windows boxes are configured with the same parameters, in the network
  settings dialogues.



  7.1.5.  Preparing DNS Before Moving Your Domain

  If you decide to move your domain to a new IP number, either because
  you have to change your ISP or because you've changed some details of
  your service which require you to move to a new IP number from the
  same ISP, you will have to make a few preparations ahead of the move.


  You want to set things up so that the IP number fetched by a DNS
  lookup somewhere in the outside world points properly to the original
  IP number until you move, and then quickly points to the new IP number
  after you move. Remote sites can have cached your IP number, and
  subsequent queries may be answered locally from the cache, rather than
  querying the appropriate servers. The effect of this might be that
  people who had visited your site recently are unable to connect, while
  new visitors have no problems, because only the new visitors are
  getting valid uncached data. Complicating things further is the fact
  that the root-level servers are only updated twice a day, so it's
  difficult to time a change to the identities of your primary and
  secondary DNS servers in the root servers.


  The easiest way to make the transition is probably to duplicate the
  entire site, or at least the publicly visible components of it, on the
  new IP number, submit the changes, and then wait for the traffic to
  shift completely to the new IP number. This is probably not very
  practical, though.


  What you should do first is to arrange with your new ISP (or your
  current ISP if you've just changing IP numbers within a single ISP) to
  host primary and secondary DNS during the transition. This should be
  done at least a day before the move. Ask them to set the TTL on this
  record to something appropriately small (for instance, five minutes).
  The sample DNS files given earlier in this section all have TTL values
  set to 86400 seconds (1 day). If your TTL is longer than this, you
  will have to arrange the change that much more in advance of the move.
  Ultimately, here's what you have to achieve. If your current domain
  information TTL is, say, N hours, then the following have to be
  finished more than N hours before the move:

  ·  Your domain registration entry must show primary and secondary DNS
     on the new ISP's machines in the root database. Allow at least a
     day between the time you submit the change and the time the change
     enters the database.

  ·  The new primary and DNS servers should point to the original IP
     numbers of your site, with a fairly small TTL.

     Note that you cannot accelerate this process by reducing your
     current domain TTL value, unless you've also done this at least N
     hours before the move.


  Now, you're ready for the move. Move your machines over to the new IP
  numbers. Synchronize this with an update of the DNS records on your
  ISP to point to the new numbers. Within five minutes (the small TTL
  you set for the move), the traffic should have switched over to the
  new site. You can now rearrange the DNS authority to your liking,
  making yourself primary if that's how you want it, and putting the TTL
  back up to a reasonably large value.



  7.2.  DNS Configuration If You Are Not Hosting Email

  The configurations described in section ``Setting Up Name Resolution''
  have MX records pointing to a machine ``mail.example.com''. The MX
  record with the lowest priority number following tells remote sites
  where to send email. Other MX records with higher priority numbers are
  used as backup email receivers. These backups will hold the mail for a
  certain period of time if the primary email receiver is not able to
  accept the messages for some reason. In the examples in that section,
  I have assumed that fred.example.com, under its alias of
  mail.example.com, is handling email for the domain. If you have chosen
  to let the ISP handle all of your email hosting, you should change
  those MX records to point to the appropriate ISP machines. Ask your
  ISP technical support representative what host names you should use
  for the MX records in the various files.



  7.3.  Setting up Electronic Mail

  If you have chosen to do full electronic mail hosting for your domain,
  you'll have to take special actions for email coming from hosts on the
  private network, and for allowing transparent mail reading from
  anywhere within the private network. Unless you're careful, messages
  are likely to sit around for long times if they are waiting on one
  host, and the intended recipient is logged on another machine. For
  security reasons, I recommend that the incoming email not be
  accessible from the externally visible hosts (this might help to
  discourage a PHB who wants his desktop machine to be on a real IP,
  then wonders why he gets brought down by a ping of death twice a day).
  A transparent email sharing system on the private network fairly
  straight-forward in sendmail. If anybody wants to provide tested
  solutions for other mail handling daemons, I welcome additions.


  7.3.1.  A Solution Using "sendmail"

  In order that email delivered to one host be visible on all machines,
  the simplest solution is to export the mail spool directory with read-
  write privileges over the entire private network. The private network
  gateway machine will also act as mail collector and forwarder for the
  entire private network, and so must have root write privileges to the
  mail spool drive. The other clients may or may not squash root, at
  your discretion. My general security philosophy is not to grant
  privileges unless there is a clear reason for it, so I squash root on
  the mail spool network drive for all hosts except the private network
  gateway machine. This has the effect that root can only read his mail
  from that machine, but this is not a particularly serious handicap.
  Note that the mail spool drive can be a directory on the private
  network gateway machine, exported via NFS, or it can be a directory on
  one of the internal servers, exported to the entire private network.
  If the mail spool drive is resident on the private network gateway,
  there is no issue of squashing root for that machine. If it is on
  another server, then note that email will be undeliverable if that
  server, the gateway machine, or the network connecting them, is down.


  For Windows machines on your private network, you may either set up a
  POP server on the mail spool host, or use samba to export the mail
  spool to those machines. The Windows machines should be configured to
  send and retrieve mail under a Linux username, such as
  joeuser@example.com, so that the email address host name is the bare
  domain name, not a machine name like barney.example.com. The outgoing
  SMTP host should be set to the private network gateway machine, which
  will be responsible for forwarding the mail and doing any address
  rewriting.


  Next, you should configure sendmail to forward email from the machines
  on the private network, rewriting the addresses if necessary. Obtain
  the latest sources to sendmail from the sendmail.org WWW site
  <http://www.sendmail.org/>. Compile the binaries, then go to the
  cf/domain subdirectory within the sendmail source tree, and create the
  following new file: example.com.m4



  ______________________________________________________________________
  divert(-1)
  #
  # Copyright (c) 1998 Sendmail, Inc.  All rights reserved.
  # Copyright (c) 1983 Eric P. Allman.  All rights reserved.
  # Copyright (c) 1988, 1993
  #       The Regents of the University of California.  All rights reserved.
  #
  # By using this file, you agree to the terms and conditions set
  # forth in the LICENSE file which can be found at the top level of
  # the sendmail distribution.
  #
  #

  #
  #  The following is a generic domain file.  You should be able to
  #  use it anywhere.  If you want to customize it, copy it to a file
  #  named with your domain and make the edits; then, copy the appropriate
  #  .mc files and change `DOMAIN(generic)' to reference your updated domain
  #  files.
  #
  divert(0)
  define(`confFORWARD_PATH', `$z/.forward.$w+$h:$z/.forward+$h:$z/.forward.$w:$z/.forward')dnl
  FEATURE(redirect)dnl
  MASQUERADE_AS(example.com)dnl
  FEATURE(masquerade_envelope)dnl
  ______________________________________________________________________



  This defines the domain ``example.com''. Next, you have to create the
  sendmail.cf files which will be used on the mail host (the private
  network gateway), and on the other Linux nodes on the private network.


  Create the following file in the sendmail source tree, under cf/cf:
  example.master.m4



  ______________________________________________________________________
  divert(-1)
  #
  # Copyright (c) 1998 Sendmail, Inc.  All rights reserved.
  # Copyright (c) 1983 Eric P. Allman.  All rights reserved.
  # Copyright (c) 1988, 1993
  #       The Regents of the University of California.  All rights reserved.
  #
  # By using this file, you agree to the terms and conditions set
  # forth in the LICENSE file which can be found at the top level of
  # the sendmail distribution.
  #
  #

  #
  #  This is the prototype file for a configuration that supports nothing
  #  but basic SMTP connections via TCP.
  #
  #  You MUST change the `OSTYPE' macro to specify the operating system
  #  on which this will run; this will set the location of various
  #  support files for your operating system environment.  You MAY
  #  create a domain file in ../domain and reference it by adding a
  #  `DOMAIN' macro after the `OSTYPE' macro.  I recommend that you
  #  first copy this to another file name so that new sendmail releases
  #  will not trash your changes.
  #

  divert(0)dnl
  OSTYPE(linux)dnl
  DOMAIN(example.com)dnl
  FEATURE(nouucp)
  FEATURE(relay_entire_domain)
  FEATURE(`virtusertable', `hash /etc/sendmail/virtusertable')dnl
  FEATURE(`genericstable', `hash /etc/sendmail/genericstable')dnl
  define(`confPRIVACY_FLAGS', ``noexpn,novrfy'')dnl
  MAILER(local)
  MAILER(smtp)
  Cw fred.example.com
  Cw example.com
  ______________________________________________________________________



  In this example we have disabled the ``expn'' and ``vrfy'' commands.
  An attacker could troll for aliases with ``expn'', trying names like
  ``staff'', ``allstaff'', ``office'', and so on, until he hits an alias
  which expands out several usernames for him. He can then try the user­
  names against certain weak passwords in hopes of getting in (assuming
  he can get a login prompt - the security settings described in section
  ``Securing Your Domain'' are set up so that no login prompt is avail­
  able for off-site attackers).


  The other file you should create will define the sendmail.cf for the
  slave machines: example.slave.m4



  ______________________________________________________________________
  divert(-1)
  #
  # Copyright (c) 1998 Sendmail, Inc.  All rights reserved.
  # Copyright (c) 1983 Eric P. Allman.  All rights reserved.
  # Copyright (c) 1988, 1993
  #       The Regents of the University of California.  All rights reserved.
  #
  # By using this file, you agree to the terms and conditions set
  # forth in the LICENSE file which can be found at the top level of
  # the sendmail distribution.
  #
  #

  #
  #  This the prototype for a "null client" -- that is, a client that
  #  does nothing except forward all mail to a mail hub.  IT IS NOT
  #  USABLE AS IS!!!
  #
  #  To use this, you MUST use the nullclient feature with the name of
  #  the mail hub as its argument.  You MUST also define an `OSTYPE' to
  #  define the location of the queue directories and the like.
  #  In addition, you MAY select the nocanonify feature.  This causes
  #  addresses to be sent unqualified via the SMTP connection; normally
  #  they are qualified with the masquerade name, which defaults to the
  #  name of the hub machine.
  #  Other than these, it should never contain any other lines.
  #

  divert(0)dnl

  OSTYPE(linux)
  FEATURE(nullclient, fred.$m)
  Cm example.com
  ______________________________________________________________________



  You build the appropriate sendmail.cf files with the command:


       make example.master.cf example.slave.cf



  and then copy the files to the appropriate machines under the name
  sendmail.cf.


  This configuration puts most of the sendmail configuration files under
  the /etc/sendmail/ subdirectory. This configuration causes sendmail to
  parse and use two special files, virtusertable.db and
  genericstable.db. To use these special files, create their parent
  files. First, virtusertable.src:


       ______________________________________________________________________
       John.Public@example.com                 jpublic
       Jane.Doe@example.com                    jdoe@somemachine.somedomain
       abuse@example.com                       root
       Pointyhaired.Boss@example.com           #phb#@hotmail.com
       ______________________________________________________________________

  This maps the email addresses on incoming email to new destinations.
  Mail sent to John.Public@example.com is delivered locally to the Linux
  account jpublic. Mail to Jane.Doe@example.com is redirected to another
  email account, possibly in a different domain. Mail to abuse@exam­
  ple.com is sent to root, and so on.  The other file is generic­
  stable.src:


       ______________________________________________________________________
       jpublic                                 John.Public@example.com
       janedoe                                 Jane.Doe@example.com
       whgiii                                  Pointyhaired.Boss@example.com
       ______________________________________________________________________



  This file renames the sender on outgoing email from locally-sourced
  mail. While it clearly can't affect the return address for mail sent
  directly from jdoe@somemachine.somedomain, it allows you to rewrite
  the sender's email address from the internal usernames to whatever
  email address convention you've chosen. Finally, create the following
  Makefile in /etc/sendmail/:


       ______________________________________________________________________
       all : genericstable.db virtusertable.db

       virtusertable.db : virtusertable.src
               makemap hash virtusertable < virtusertable.src

       genericstable.db : genericstable.src
               makemap hash genericstable < genericstable.src
       ______________________________________________________________________



  Run make to create the hashed files which sendmail can use, and remem­
  ber to re-run make and restart sendmail (or send it a SIGHUP) after
  any changes to either of these ``.src'' files.



  7.3.2.  Solutions Using Other Mail Transfer Agents

  My experience is only with sendmail. If anybody would like to write
  this section, please contact me. Otherwise, I may, at some later time,
  try to provide details myself on such MTAs as Postfix, Exim, or smail.
  I'd really rather somebody wrote these sections who uses those
  programs.



  7.4.  Setting up Web Space Hosting

  You should set up your externally visible web server on a machine
  outside the private network, and not on the private network gateway
  machine, for security reasons. If the web server needs access to
  databases or other resources stored on the private network, the
  situation becomes more complicated, both from a network and a security
  standpoint. Such configurations are beyond the scope of this document.


  The details of setting up the server itself can be found in the apache
  documentation, and in the Linux WWW HOWTO
  <ftp://metalab.unc.edu/pub/Linux/docs/HOWTO/WWW-HOWTO> document.



  7.5.  Setting up FTP Hosting

  Once again, your FTP host should be an externally visible machine, and
  not the private network gateway machine. Follow the setup directions
  which ship with your FTP daemon package. Be sure to download the most
  recent version of the daemon, as there are security vulnerabilities in
  some older versions of many daemons. If your FTP site does not require
  anonymous users to upload files, be sure to disable that feature in
  the daemon. I recommend that user (non-anonymous) FTP logins not be
  permitted on the FTP host, that you require your regular users to use
  scp, the secure shell remote copy command, for any file updating they
  may have to do on the FTP host. This is to help build secure habits in
  the users, and to protect against the ``hostile router'' problem
  described in section ``Securing Your Domain''.



  7.6.  Setting up Packet Filtering

  This is discussed in detail in section ``Configuring Your Firewall''.



  8.  Securing Your Domain

  This section deals with setting up security for your new domain. The
  emphasis is on user-transparent features. If your security is too
  obtrusive, and interferes strongly with the actions of the users, the
  users will develop their own workarounds which may compromise the
  entire domain. The best way to avoid this is to make the security as
  transparent as possible, and to encourage users to come to you first
  when they have difficulties which might be related to the security
  measures of the site. A certain flexibility in attitude is important.
  I know from personal experience that if the security policy is too
  rigid, the users will simply set up their own network tunnels through
  the firewall so they can log in from outside the domain. It's better
  that remote login procedures, or whatever the users are trying to do,
  be set up, inspected, and approved by you.


  This section deals with securing your network against outside attack,
  and against casual snooping from within. Securing your site against
  determined attack from validated users within the private network is a
  more difficult and involved task, and is beyond the scope of this
  document.


  One of the security considerations used in this section is protecting
  against the ``hostile router''. The router provided by your ISP may be
  a remotely configurable computer in its own right, with the
  administrative password held by your provider. There have been
  security problems in the past when the router's manufacturer override
  password (the one used when your ISP forgets the password they
  programmed in) has become known to system crackers. When possible, you
  should design your security around the assumption that the router is
  potentially hostile. That is, it could be using any IP number in your
  public or private network blocks, it could be redirecting traffic on
  outgoing packets to another site, and it could be recording anything
  which goes through.

  8.1.  Configuring Your Firewall

  This section deals with configuring an ipchains-based masquerading,
  forwarding, filtering router. You should probably read the IPCHAINS-
  HOWTO <ftp://metalab.unc.edu/pub/Linux/docs/HOWTO/IPCHAINS-HOWTO>
  document first, then look here for additional hints. That HOWTO
  describes the steps necessary to compile a kernel with masquerading
  support, and describes the use of the ipchains binary in detail. You
  should enable firewalling on all machines with exposed IP numbers.


  Check your startup scripts to make sure that the sequence is as
  follows on the private network gateway machine:

  1. Outside Ethernet card is initialized.

  2. Firewall rules are run through ipchains.

  3. Forwarding is turned on.

  4. Network service daemons are started.

  So, as an example, on a Slackware-based system, the firewall
  configuration should come between the execution of rc.inet1 and
  rc.inet2. Further, if any problems arise during the firewall
  configuration steps, a warning should be printed, and the external
  Ethernet card taken off line before the network service daemons are
  run.


  One common problem with ipchains-based firewalls is the tedium of
  making sure that your rules are correctly set for packets arriving
  from the loopback interface, or arriving from either of the internal
  or external interfaces on the firewall machine. These locally-sourced
  packets can be blocked by a firewall. All too often, this is fixed by
  a sort of shotgun debugging approach, whereby the rules for the
  firewall are tweaked until all applications seem to run properly on
  the firewall host again. Unfortunately, this can sometimes result in a
  firewall which has unintended holes. With ipchains it is possible to
  write a firewall script which is easily debugged, and which avoids
  many of the packet source problems. Here is a sample script,
  /sbin/firewall.sh:



  ______________________________________________________________________
  #! /bin/sh
  #
  # New firewalling script using IP chains. Creates a filtering router
  # with network masquerading.
  #

  # define a few variables

  IPCHAINS=/sbin/ipchains

  LOCALNET="192.168.1.0/24"   # the private network
  ETHINSIDE="192.168.1.1"             # fred.example.com's private IP #
  ETHOUTSIDE="10.1.1.9"               # fred.example.com's public IP #
  LOOPBACK="127.0.0.1/8"
  ANYWHERE="0/0"
  OUTSIDEIF=eth1                  # fred.example.com's private interface

  FORWARD_PROCENTRY=/proc/sys/net/ipv4/ip_forward

  #
  # These two commands will return error codes if the rules
  # already exist (which happens if you run the firewall
  # script more than once). We put the commands before "set -e"
  # so that the script doesn't abort in that case.

  $IPCHAINS -N outside
  $IPCHAINS -N portmap

  set -e                  # Abort immediately on error setting
                          # up the rules.


  #
  # Turn off forwarding and clear the tables

  echo "0" > ${FORWARD_PROCENTRY}

  $IPCHAINS -F forward
  $IPCHAINS -F input
  $IPCHAINS -F output
  $IPCHAINS -F outside
  $IPCHAINS -F portmap


  #
  # Masquerade packets from within our local network destined for the
  # outside world. Don't masquerade packets which are local to local

  $IPCHAINS -A forward -s $LOCALNET -d $LOCALNET -j ACCEPT
  $IPCHAINS -A forward -s $ETHOUTSIDE -d $ANYWHERE -j ACCEPT
  $IPCHAINS -A forward -s $LOCALNET -d $ANYWHERE -j MASQ

  #
  # Set the priority flags. Minimum delay connections for www, telnet,
  # ftp, and ssh (outgoing packets only).

  $IPCHAINS -A output -p tcp -d $ANYWHERE www -t 0x01 0x10
  $IPCHAINS -A output -p tcp -d $ANYWHERE telnet -t 0x01 0x10
  $IPCHAINS -A output -p tcp -d $ANYWHERE ftp -t 0x01 0x10
  $IPCHAINS -A output -p tcp -d $ANYWHERE ssh -t 0x01 0x10


  #
  # Anything from our local class C is to be accepted, as are
  # packets from the loopback and fred's external IP.
  $IPCHAINS -A input -s $LOCALNET -j ACCEPT
  $IPCHAINS -A input -s $LOOPBACK -j ACCEPT
  $IPCHAINS -A input -s $ETHOUTSIDE -j ACCEPT



  # We'll create a set of rules for packets coming from the big, bad
  # outside world, and then bind all external interfaces to it. This
  # rule will be called "outside"
  #
  # We also create a "portmap" chain. The sockets used by daemons
  # registered with the RPC portmapper are not fixed, and so it is
  # a bit difficult to set up filter rules for them. The portmap
  # chain is configured in a separate script.


  #
  # Send packets from any outside interface to the "outside"
  # rules chain. This includes the $OUTSIDEIF interface and any
  # ppp interfaces we create for dialout (or dialin).

  $IPCHAINS -A input -i ${OUTSIDEIF} -j outside
  $IPCHAINS -A input -i ppp+ -j outside


  ##################################################
  #
  #  Set up the "outside" rules chain              #
  #
  ##################################################

  #
  # Nobody from the outside should claim to be coming from our localnet
  # or loopback

  $IPCHAINS -A outside -s $LOCALNET -j DENY
  $IPCHAINS -A outside -s $LOOPBACK -j DENY

  #
  # No packets routed to our local net should come in from outside
  # because the outside isn't supposed to know about our private
  #  IP numbers.

  $IPCHAINS -A outside -d $LOCALNET -j DENY

  #
  # Block incoming connections on the X port. Block 6000 to 6010.

  $IPCHAINS -l -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 6000:6010 -j DENY

  #
  # Block NFS ports 111 and 2049

  $IPCHAINS -l -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 111 -j DENY
  $IPCHAINS -l -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 2049 -j DENY
  $IPCHAINS -l -A outside -p UDP -s $ANYWHERE -d $ANYWHERE 111 -j DENY
  $IPCHAINS -l -A outside -p UDP -s $ANYWHERE -d $ANYWHERE 2049 -j DENY

  #
  # Block XDM packets from outside, port 177 UDP

  $IPCHAINS -l -A outside -p UDP -s $ANYWHERE -d $ANYWHERE 177 -j DENY


  #
  # Block the YP/NIS port 653
  $IPCHAINS -l -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 653 -j DENY

  #
  # Don't bother logging accesses on TCP port 80, the www port.

  $IPCHAINS -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 80 -j DENY

  #
  # Accept FTP data and control connections.

  $IPCHAINS -A outside -p TCP -s $ANYWHERE 20:21 -d $ANYWHERE 1024: -j ACCEPT

  #
  # Accept ssh packets

  $IPCHAINS -A outside -p TCP -s $ANYWHERE -d $ANYWHERE ssh -j ACCEPT

  #
  # Accept DNS packets from outside

  $IPCHAINS -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 53 -j ACCEPT
  $IPCHAINS -A outside -p UDP -s $ANYWHERE -d $ANYWHERE 53 -j ACCEPT

  #
  # Accept SMTP from the world

  $IPCHAINS -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 25 -j ACCEPT

  #
  # Accept NTP packets

  $IPCHAINS -A outside -p UDP -s $ANYWHERE -d $ANYWHERE 123 -j ACCEPT

  #
  # Accept no tap ident packets, we don't use them

  $IPCHAINS -A outside -p TCP -s $ANYWHERE -d $ANYWHERE 113 -j DENY

  #
  # Turn off and log all other packets incoming, TCP or UDP, on privileged ports

  $IPCHAINS -l -A outside -p TCP -s $ANYWHERE -d $ANYWHERE :1023 -y -j DENY
  $IPCHAINS -l -A outside -p UDP -s $ANYWHERE -d $ANYWHERE :1023 -j DENY

  #
  # Check against the portmapper ruleset

  $IPCHAINS -A outside -j portmap


  ##############################################
  #
  #    End of "outside" rules chain            #
  #
  ##############################################


  #
  # Block outgoing rwho packets

  $IPCHAINS -A output -p UDP -i $OUTSIDEIF -s $ANYWHERE 513 -d $ANYWHERE -j DENY

  #
  # Prevent netbios packets from leaving

  $IPCHAINS -A output -p UDP -i $OUTSIDEIF -s $ANYWHERE 137 -d $ANYWHERE -j DENY
  #
  # Turn on forwarding

  echo "1" > ${FORWARD_PROCENTRY}
  ______________________________________________________________________



  Notice that the firewall can be used not only to block incoming pack­
  ets, but also outgoing packets which might leak information about your
  private network, such as rwho and netbios packets.


  As noted earlier, the portmapper rules are a bit different, because
  the portmap daemons register themselves with the portmapper and are
  told which ports to listen on. The ports used by a particular daemon
  may change as you change the RPC services used, or change their order
  of startup. The following script, /sbin/firewall.portmap.sh generates
  rule sets for the portmapped daemons:


       ______________________________________________________________________
       #! /bin/sh
       #
       ANYWHERE=0/0

       IPCHAINS=/sbin/ipchains

       $IPCHAINS -F portmap

       # Rules for preventing access to portmapped services by people on the outside
       #
       /usr/bin/rpcinfo -p | tail +2 | \
               { while read program vers proto port remainder
                 do
                       prot=`echo $proto | tr "a-z" "A-Z"`
                       $IPCHAINS -l -A portmap -p $prot -s $ANYWHERE -d $ANYWHERE $port -j DENY || exit 1
                 done
               }
       ______________________________________________________________________



  We didn't have to worry about whether packets coming in were legiti­
  mate packets from the private network, the portmap chain is only
  checked when the packets come in from the outside.


  This firewall configuration logs most suspicious packets through klogd
  with the kern.info logging priority. It will log normal connection
  attempts, as well as all known ``stealth'' probes.


  Now, we put these all together. We'd like to make sure that there
  isn't a small window of vulnerability while the system is starting up,
  so you should configure your startup sequence as follows:



  ______________________________________________________________________
  #! /bin/sh
  #
  # Get the network started, securely
  #
  #
  /etc/rc.d/rc.inet1              # Configure the network interfaces
                                  # and set up routing.
  /sbin/firewall.sh || { echo "Firewall configuration failed"
                         /sbin/ifconfig eth1 down }

  /sbin/ipchains -I outside 1 -j DENY     # Deny all incoming packets

  /etc/rc.d/rc.inet2              # Start the network daemons

  sleep 5                         # Let them stabilize

  # Secure the portmapped services
  /sbin/firewall.portmap.sh || { echo "Portmap firewall configuration failed"
                                 /sbin/ifconfig eth1 down }

  /sbin/ipchains -D outside 1       # Allow incoming packets
  ______________________________________________________________________



  This assumes that eth1 is the interface on the externally visible IP
  number. If any of the ipchains rule sets fail to install, a warning is
  issued and that interface is taken off line. The ``outside'' chain is
  set to deny all packets before the network service daemons are
  started, because the firewalling rules are not yet in place for the
  portmapped services. Once the portmapped services are firewalled, the
  ``outside'' chain is restored to its proper behaviour.



  8.2.  Configuring OpenSSH or SSH1

  At the time of this writing, OpenSSH, like SSH1, now offers a
  configuration setting which allows you to insert scp, ssh, and slogin
  as binaries named rcp, rsh, and rlogin, with transparent fall-through
  in the ssh client programs to the original rsh, rcp, or rlogin when
  the remote site isn't running sshd. Making an invocation of rsh run,
  instead, the ssh client program is, in my opinion, important for
  keeping the security easy to use and out of the way of the users.
  Everybody's scripts, rdist configurations, and so on will continue to
  work without modification if the remote site is running sshd, but data
  will be sent encrypted, with strong host authentication. The converse
  will not always be true. Specifically, if the remote machine is not
  running sshd, the rsh program will echo a diagnostic to the screen
  warning that the connection is unencrypted. This message breaks rdist,
  and possibly other programs. The message cannot be suppressed with
  command line or compile time switches. For rdist, one solution is to
  invoke the program with -p /usr/lib/rsh/rsh.


  Obtain ssh1 from the ssh web site <http://www.ssh.org/>, or OpenSSH
  from the OpenSSH web site <http://www.openssh.org/>, and compile it to
  replace the unencrypted r-programs (rsh, rlogin, and rcp). First, copy
  those three files to /usr/lib/rsh/, then configure the ssh package
  with:


        ./configure --with-rsh=/usr/lib/rsh/rsh --program-transform-name='s/^s/r/' --prefix=/usr

  Install the binaries, and configure according to the directions. On
  the private network gateway machine, make sure that the sshd configu­
  ration has the following entries defined:


       ListenAddress 192.168.1.1       # fred's internal IP
       IgnoreRhosts no
       X11Forwarding yes
       X11DisplayOffset 10
       RhostsAuthentication no
       RhostsRSAAuthentication yes
       RSAAuthentication yes
       PasswordAuthentication yes



  You will have to do further configuration of other entries in the
  /etc/sshd_config file, but try not to change these fields. Once you
  have all of the entries in the file set to your satisfaction, copy
  this entire file into a new file, /etc/sshd_config.ext, for the exter­
  nal network. Change two fields in the new file: the ``ListenAddress''
  should be changed to the private network gateway's external IP number
  (10.1.1.9 in our fred.example.com case), and ``PasswordAuthentica­
  tion'' should be set to ``no'' in /etc/sshd_config.ext. In your net­
  work services startup script, start sshd twice, once with


       /usr/sbin/sshd



  and once with


       /usr/sbin/sshd -f /etc/sshd_config.ext



  This will create two running sshd daemons. The one operating on the
  internal interface will allow logins with passwords, but the external
  interface will require an RSA key validation before anybody can log
  on.


  Next, turn off incoming telnet and shell services in the inetd
  configuration file (note that the firewall configuration listed in
  section ``Configuring Your Firewall'' already prevents access from
  outside, but it's best to defend in depth, don't rely on everything
  working correctly).


  People who want to be able to log in from home, or from out of town,
  will need an RSA key. Make sure they know how to do this, so they
  don't spend their energies trying to figure out another way to do it,
  like running a telnetd on an unprivileged port on your firewall
  machine.


  An RSA key is generated by the command:


       ssh-keygen -b 1024 -f new_rsa_key

  You will be prompted for a pass phrase. This should not be blank. A
  person with access to the file new_rsa_key, and knowledge of the pass
  phrase, has everything necessary to pass an RSA authentication chal­
  lenge. The pass phrase can be an ``unguessable'' password, or a long
  sentence, but make it something non-trivial. The file new_rsa_key can
  be copied to a floppy disk, or onto a laptop, and, along with the pass
  phrase, can be used to log into accounts which are set to grant access
  to that particular RSA key.


  To configure an account to allow access by a particular RSA key,
  simply create a $HOME/.ssh/ directory for that user on the private
  network gateway machine (i.e. the machine which will be receiving the
  login attempt), and copy the file new_rsa_key.pub which was created by
  the "ssh-keygen" command into the file $HOME/.ssh/authorized_keys. See
  the section ``AUTHORIZED_KEYS FILE FORMAT'' in the sshd man page for
  details on other options you can add to the key, such as requiring the
  login to come from a certain IP or host name, or authorizing the key
  only to permit the remote invocation of certain commands (for
  instance, an RSA key which commands a backup to take place, or
  commands a status report to be emailed somewhere off site).


  Only one thing remains to make the RSA key mechanism as gentle as
  possible to the users. If a user is forced to enter the pass phrase
  more than once or twice in a session, they are likely to become bored
  and take security matters into their own hands. Under Linux, arrange
  their login shell to be invoked under ssh-agent. For instance, if the
  company laptop used on business trips runs xdm, and drops users into
  an X session, go into the /var/X11R6/lib/xdm/Xsession_0 file and
  change the lines which invoke the startup, which are probably of the
  form:


       exec "$startup"



  into lines of the form:


       exec ssh-agent "$startup"



  In my xdm setup, there are three such lines which should be altered in
  that one file. Now, when the user logs onto the laptop, he enters the
  command


       ssh-add new_rsa_key



  at any prompt, enters the pass phrase when prompted, and all windows
  will have pass phrase-free access to the account on the private net­
  work gateway until the user logs off his X session on the laptop.


  Run sshd on all of the machines on your private network, as well as on
  any exposed hosts. For machines other than the private network gateway
  machine, the ListenAddress entry in /etc/sshd_config can be set to
  ``0.0.0.0''.  You should set up the host keys with the command:
       ssh-keygen -b 1024 -f /etc/ssh_host_key -N ""



  then run make-ssh-known-hosts and distribute the /etc/ssh_known_hosts
  file among all of the machines on the private and public networks.


  Disable incoming telnet and the unencrypted r-services. Don't delete
  the telnet binary, it's useful for things other than simple telnet
  sessions on port 23. You should allow password authentication on the
  private network, and disable it on the exposed machines, requiring an
  RSA key to log onto the exposed hosts.


  It is convenient for the users if the hosts on the private network are
  mentioned in each other's /etc/hosts.equiv files. The sshd daemons
  will respect those, and allow people to rlogin and rsh between
  machines without passwords or pass phrases. On every connection, the
  machines will be verifying each other's identities with host-level RSA
  keys.


  One difficulty arises when a user logged onto a machine on the private
  network wants to log onto a box on an exposed IP number. You can't use
  /etc/hosts.equiv or $HOME/.shosts to allow password-less validation,
  because the user is coming from a machine whose IP number cannot be
  determined - it will appear to be coming from the masquerading
  firewall machine, but the host keys won't match. There are two
  solutions to this. First, if you insist on using the /etc/hosts.equiv
  or $HOME/.shosts methods, the user will have to log onto the private
  network gateway machine (fred.example.com in our example here), and
  then log through to the exposed machine from there. The other
  technique is to use RSA key authentication, that always works
  regardless of what games are going on with IP numbers and host name
  lookups.



  8.3.  Configuring X

  In the user's continuing quest to prove that he values convenience
  over security, it has become common for people to put


       xhost +



  commands right into their X initialization scripts. This grants X
  server access to everybody in the world. Now the random outsider can
  change your root window graphic to something embarrassing while your
  boss is showing his mother around your office. Alternately, this out­
  sider can quietly monitor every keystroke you issue, and dump the con­
  tents of your screen to his desktop. Needless to say, this doesn't
  bode well for passwords used to log into other sites, or for sensitive
  documents being edited on screen. The xhost protocol itself is inher­
  ently limited, as it is not possible to grant permissions to use the
  screen on a user basis, only on a machine basis.


  Enter xauth authentication. If you have xdm you probably already are
  running xauth authentication, but xhost still works, and might still
  be what people are using to run X processes between machines. Once
  again, the goal is to make the security easy enough to use that the
  users aren't tempted to run the xhost command anymore.


  The sshd setup described in section ``Configuring SSH1'', with the
  ``X11Forwarding'' flag set, is actually simpler to use than the xhost
  technique. Once you have logged into your terminal, you can simply
  rlogin to a remote machine, and run netscape, xv, or whatever you
  like, without having to set the $DISPLAY variable name or allow
  explicit permissions. During ssh login, it configures the system in a
  way transparent to the end user, and even encrypts all of your X
  packets before they go over the network.


  If you are unable to use the sshd X11 forwarding for some reason, you
  should use xauth when you want to authorize other machines to have
  access to your X server. Document this for the users, or create
  specialized shell scripts to help them out. The relevant command to
  authorize a particular login, ``jpublic'', on machine ``barney'' to
  have access to your X server is:



       /usr/X11/bin/xauth extract - $DISPLAY | rsh -l jpublic barney /usr/X11/bin/xauth merge -



  This sequence is not necessary to authorize X connections from
  machines which share a common NFS-mounted home directory. The xauth
  key will be immediately available to that user on all machines which
  mount the same home directory.


  I'd be tempted to delete xhost from your machines entirely. If it
  causes problems with any programs, you will at least know that those
  programs had poorly-designed security. It's simple enough to build a
  shell script as a drop-in replacement for xhost which uses the xauth
  sequence listed above.


  Note that if rsh is not the encrypting ssh program, the xauth key is
  sent plaintext. Anybody who holds the plaintext of the key can access
  your server, so you do not gain much security if you don't use ssh for
  these transactions. Note, also, that if the users' home directories
  are exported via NFS (the Network File System), the xauth key is
  available in plaintext to anybody able to snoop those NFS packets,
  regardless of whether you're running ssh on your systems.



  8.4.  Configuring Disk Sharing

  With email coming to a central machine, the read/send from any host
  setup described here is very convenient, but some care has to be taken
  to protect against trivial snooping by bored local users. NFS without
  AUTH_DES implemented is inherently insecure. NFS relies on the client
  machine to authenticate access, there is no password verification on
  the server to make sure that the client should be permitted to access
  the private files of a particular user. A Windows box can be
  configured to read NFS-exported volumes as any numeric uid, completely
  bypassing UNIX file permissions.  Consequently, NFS exports should
  only be made to machines which are always Linux (or UNIX) boxes under
  your direct control, and never ones which can be dual-booted into
  Windows.  If you want to export the mail spool directory, or any other
  directory, to machines which can sometimes be used as Windows boxes,
  export them with samba, setting the authentication mode to
  ``security=USER''. Connecting the machines on your network with a
  switch rather than a hub will also help, as it leaves very little of
  interest for sniffers on Windows machines. Ultimately, though, it's
  very difficult to secure any disk sharing over the network at the time
  of this writing.


  Why bother, if you can't really secure the network disks? Mostly it's
  an issue of credible defense. If you leave a sheet of paper on your
  desk with confidential information, and somebody in the office reads
  it, he can argue that he didn't realize what the paper was, his
  natural curiosity just got the better of him when he saw it sitting on
  the desk. If the sheet of paper were in a filing cabinet or desk
  drawer, it's an entirely different story. The purpose of taking some
  basic network security measures internally is to ensure that nobody
  ``accidentally'' compromises security.



  9.  Acknowledgements

  This document was written as internal documentation for the DYNACAN
  project, as part of the project's continuing development under the
  control of the Ministry of Human Resources Development Canada.


  This document has benefited considerably from the suggestions of

  ·  Rod Smith (rodsmith@rodsbooks.com <mailto:rodsmith@rodsbooks.com>),
     who suggested I provide details on registering a domain name and on
     setting up with a dynamic IP, and pointed me at the various dynamic
     IP hosting services and at Granite Canyon.

  ·  Greg Leblanc (gleblanc@my-deja.com <gleblanc@my-deja.com>) for
     useful suggestions on improving the clarity of the document.

  ·  Sami Yousif (syousif@iname.com <mailto:syousif@iname.com>).

  ·  Marc-André Dumas (m_a_dumas@hotmail.com
     <mailto:m_a_dumas@hotmail.com>), who suggested the section on
     moving your domain to a new IP number.

  ·  Osamu Aoki (aoki@pacbell.net <mailto:aoki@pacbell.net>).

  ·  Joao Ribeiro <(url url="mailto:sena@decoy.ath.cx"
     name="sena@decoy.ath.cx">).

12.1. Names and locations

The first thing your browser has to do is to establish a network connection
to the machine where the document lives. To do that, it first has to find the
network location of the host www.tldp.org (??host?? is short for ??host
machine?? or ??network host'; www.tldp.org is a typical hostname). The
corresponding location is actually a number called an IP address (we'll
explain the ??IP?? part of this term later).

To do this, your browser queries a program called a name server. The name
server may live on your machine, but it's more likely to run on a service
machine that yours talks to. When you sign up with an ISP, part of your setup
procedure will almost certainly involve telling your Internet software the IP
address of a nameserver on the ISP's network.

The name servers on different machines talk to each other, exchanging and
keeping up to date all the information needed to resolve hostnames (map them
to IP addresses). Your nameserver may query three or four different sites
across the network in the process of resolving www.tldp.org, but this usually
happens very quickly (as in less than a second). We'll look at how
nameservers detail in the next section.

The nameserver will tell your browser that www.tldp.org's IP address is
152.19.254.81; knowing this, your machine will be able to exchange bits with
www.tldp.org directly.
-----------------------------------------------------------------------------

12.2. The Domain Name System

The whole network of programs and databases that cooperates to translate
hostnames to IP addresses is called ??DNS?? (Domain Name System). When you
see references to a ??DNS server??, that means what we just called a
nameserver. Now I'll explain how the overall system works.

Internet hostnames are composed of parts separated by dots. A domain is a
collection of machines that share a common name suffix. Domains can live
inside other domains. For example, the machine www.tldp.org lives in the
.tldp.org subdomain of the .org domain.

Each domain is defined by an authoritative name server that knows the IP
addresses of the other machines in the domain. The authoritative (or ??
primary') name server may have backups in case it goes down; if you see
references to a secondary name server or (??secondary DNS') it's talking
about one of those. These secondaries typically refresh their information
from their primaries every few hours, so a change made to the hostname-to-IP
mapping on the primary will automatically be propagated.

Now here's the important part. The nameservers for a domain do not have to
know the locations of all the machines in other domains (including their own
subdomains); they only have to know the location of the nameservers. In our
example, the authoritative name server for the .org domain knows the IP
address of the nameserver for .tldp.org but not the address of all the other
machines in .tldp.org.

The domains in the DNS system are arranged like a big inverted tree. At the
top are the root servers. Everybody knows the IP addresses of the root
servers; they're wired into your DNS software. The root servers know the IP
addresses of the nameservers for the top-level domains like .com and .org,
but not the addresses of machines inside those domains. Each top-level domain
server knows where the nameservers for the domains directly beneath it are,
and so forth.

DNS is carefully designed so that each machine can get away with the minimum
amount of knowledge it needs to have about the shape of the tree, and local
changes to subtrees can be made simply by changing one authoritative server's
database of name-to-IP-address mappings.

When you query for the IP address of www.tldp.org, what actually happens is
this: First, your nameserver asks a root server to tell it where it can find
a nameserver for .org. Once it knows that, it then asks the .org server to
tell it the IP address of a .tldp.org nameserver. Once it has that, it asks
the .tldp.org nameserver to tell it the address of the host www.tldp.org.

Most of the time, your nameserver doesn't actually have to work that hard.
Nameservers do a lot of cacheing; when yours resolves a hostname, it keeps
the association with the resulting IP address around in memory for a while.
This is why, when you surf to a new website, you'll usually only see a
message from your browser about "Looking up" the host for the first page you
fetch. Eventually the name-to-address mapping expires and your DNS has to
re-query ?? this is important so you don't have invalid information hanging
around forever when a hostname changes addresses. Your cached IP address for
a site is also thrown out if the host is unreachable.
-----------------------------------------------------------------------------

	
  DNS HOWTO
  Nicolai Langfeldt (dns-howto(at)langfeldt.net), Jamie Nor­
  rish and others
  v9.0, 2001-12-20

  1.2.  Credits and request for help.

  I want to thank all the people that I have bothered with reading this
  HOWTO (you know who you are) and all the readers that have e-mailed
  suggestions and notes.


  This will never be a finished document; please send me mail about your
  problems and successes.  You can help make this a better HOWTO.  So
  please send comments and/or questions or money to
  janl(at)langfeldt.net.  Or buy my DNS book (it's titled "The Concise
  Guide to DNS and BIND, the bibliography has ISBNs).  If you send e-
  mail and want an answer please show the simple courtesy of making sure
  that the return address is correct and working.  Also, please read the
  ``qanda'' section before mailing me.  Another thing, I can only
  understand Norwegian and English.


  This is a HOWTO.  I have maintained it as part of the LDP since 1995.
  I have, during 2000, written a book on the same subject.  I want to
  say that, though this HOWTO is in many ways much like the book it is
  not a watered down version concocted to market the book.  The readers
  of this HOWTO have helped me understand what is difficult to
  understand about DNS.  This has helped the book, but the book has also
  helped me to think more about what this HOWTO needs.  The HOWTO begot
  the book.  The book begot version 3 of this HOWTO.  My thanks to the
  book publisher, Que, that took a chance on me :-)

  1.3.  Dedication

  This HOWTO is dedicated to Anne Line Norheim Langfeldt.  Though she
  will probably never read it since she's not that kind of girl.


<title>DNS-Serving</title>

6.6.  Domain Name System

  A DNS server has the job of translating names (readable by humans) to
  IP addresses. A DNS server does not know all the IP addresses in the
  world; rather, it is able to request other servers for the unknown
  addresses. The DNS server will either return the wanted IP address to
  the user or report that the name cannot be found in the tables.

  Name serving on Unix (and on the vast majority of the Internet) is
  done by a program called named.  This is a part of the bind package of
  The Internet Software Consortium.

  ·  BIND <http://www.isc.org/>

  ·  DNS HOWTO <http://metalab.unc.edu/mdw/HOWTO/DNS-HOWTO.html>

<para>

  This section will describe how to become a totally small time DNS admin.

  1.  Preamble

  Keywords: DNS, BIND, BIND 4, BIND 8, BIND 9, named, dialup, PPP, slip,
  ISDN, Internet, domain, name, resolution, hosts, caching.

  This document is part of the Linux Documentation Project.

  2.  Introduction.

  What this is and isn't.

  DNS is the Domain Name System.  DNS converts machine names to the IP
  addresses that all machines on the net have.  It translates (or "maps"
  as the jargon would have it) from name to address and from address to
  name, and some other things.  This HOWTO documents how to define such
  mappings using Unix system, with a few things specific to Linux.

  A mapping is simply an association between two things, in this case a
  machine name, like ftp.linux.org, and the machine's IP number (or
  address) 199.249.150.4.  DNS also contains mappings the other way,
  from the IP number to the machine name; this is called a "reverse
  mapping".

  DNS is, to the uninitiated (you ;-), one of the more opaque areas of
  network administration.  Fortunately DNS isn't really that hard.  This
  HOWTO will try to make a few things clearer.  It describes how to set
  up a simple DNS name server, starting with a caching only server and
  going on to setting up a primary DNS server for a domain.  For more
  complex setups you can check the ``qanda'' section of this document.
  If it's not described there you will need to read the Real
  Documentation.  I'll get back to what this Real Documentation consists
  of in ``the last chapter''.


  Before you start on this you should configure your machine so that you
  can telnet in and out of it, and successfully make all kinds of
  connections to the net, and you should especially be able to do telnet
  127.0.0.1 and get your own machine (test it now!).  You also need good
  /etc/nsswitch.conf, /etc/resolv.conf and /etc/hosts files as a
  starting point, since I will not explain their function here.  If you
  don't already have all this set up and working the Networking-HOWTO
  and/or the Networking-Overview-HOWTO explains how to set it up.  Read
  them.


  When I say `your machine' I mean the machine you are trying to set up
  DNS on, not any other machine you might have that's involved in your
  networking effort.


  I assume you're not behind any kind of firewall that blocks name
  queries.  If you are you will need a special configuration --- see the
  section on ``qanda''.


  Name serving on Unix is done by a program called named.  This is a
  part of the ``BIND'' package which is coordinated by The Internet
  Software Consortium.  Named is included in most Linux distributions
  and is usually installed as /usr/sbin/named, usually from a package
  called BIND, in upper or lower case depending on the whim of the
  packager.


  If you have a named you can probably use it; if you don't have one you
  can get a binary off a Linux ftp site, or get the latest and greatest
  source from  <ftp://ftp.isc.org/isc/bind9/>.  This HOWTO is about BIND
  version 9.  The old versions of the HOWTO, about BIND 4 and 8, is
  still available at  <http://langfeldt.net/DNS-HOWTO/> in case you use
  BIND 4 or 8 (incidentally, you will find this HOWTO there too).  If
  the named man page talks about (at the very end, in the FILES section)
  named.conf you have BIND 8; if it talks about named.boot you have BIND
  4.  If you have 4 and are security conscious you really ought to
  upgrade to the latest version of BIND 8.  Now.


  DNS is a net-wide database.  Take care about what you put into it.  If
  you put junk into it, you, and others, will get junk out of it.  Keep
  your DNS tidy and consistent and you will get good service from it.
  Learn to use it, admin it, debug it and you will be another good admin
  keeping the net from falling to its knees by mismanagement.


  Tip: Make backup copies of all the files I instruct you to change if
  you already have them, so that if after going through this nothing
  works you can get it back to your old, working state.


  2.1.  Other nameserver implementations.

  This section was written by Joost van Baal.


  Various packages exist for getting a DNS server on your box.  There is
  the BIND package ( <http://www.isc.org/products/BIND/>); the
  implementation this HOWTO is about.  It's the most popular nameserver
  around and it's used on the vast majority of name serving machines on
  the Internet, around and being deployed since the 1980's.  It's
  available under a BSD license.  Since it's the most popular package,
  loads of documentation and knowledge about BIND is around.  However,
  there have been security problems with BIND.


  Then there is djbdns ( <http://djbdns.org/>), a relatively new DNS
  package written by Daniel J. Bernstein, who also wrote qmail.  It's a
  very modular suite: various small programs take care of the different
  jobs a nameserver is supposed to handle.  It's designed with security
  in mind.  It uses a simpler zone-file format, and is generally easier
  to configure.  However, since it's less well known, your local guru
  might not be able to help you with this.  Unfortunately, this software
  is not Open Source.  The author's advertisement is on
  <http://cr.yp.to/djbdns/ad.html>.


  Whether DJBs software is really an improvement over the older
  alternatives is a subject of much debate.  A discussion (or is it a
  flame-war?) of BIND vs djbdns, joined by ISC people, is on
  <http://www.isc.org/ml-archives/bind-users/2000/08/msg01075.html>


  3.  A resolving, caching name server.

  A first stab at DNS config, very useful for dialup, cable-modem, ADSL
  and similar users.


  On Red Hat and Red Hat related distributions you can achieve the same
  practical result as this HOWTO's first section by installing the
  packages bind, bind-utils and caching-nameserver.  If you use Debian
  simply install bind (or bind9, as of this writing, BIND 9 is not
  supported by Debian Stable (potato)) and bind-doc.  Of course just
  installing those packages won't teach you as much as reading this
  HOWTO.  So install the packages, and then read along verifying the
  files they installed.


  A caching only name server will find the answer to name queries and
  remember the answer the next time you need it.  This will shorten the
  waiting time the next time significantly, especially if you're on a
  slow connection.


  First you need a file called /etc/named.conf (Debian:
  /etc/bind/named.conf).  This is read when named starts.  For now it
  should simply contain:


  ______________________________________________________________________
  // Config file for caching only name server
  //
  // The version of the HOWTO you read may contain leading spaces
  // (spaces in front of the characters on these lines ) in this and
  // other files.  You must remove them for things to work.
  //
  // Note that the filenames and directory names may differ, the
  // ultimate contents of should be quite similar though.

  options {
          directory "/var/named";

          // Uncommenting this might help if you have to go through a
          // firewall and things are not working out.  But you probably
          // need to talk to your firewall admin.

          // query-source port 53;
  };

  controls {
          inet 127.0.0.1 allow { localhost; } keys { rndc_key; };
  };

  key "rndc_key" {
          algorithm hmac-md5;
          secret "c3Ryb25nIGVub3VnaCBmb3IgYSBtYW4gYnV0IG1hZGUgZm9yIGEgd29tYW4K";
  };

  zone "." {
          type hint;
          file "root.hints";
  };

  zone "0.0.127.in-addr.arpa" {
          type master;
          file "pz/127.0.0";
  };
  ______________________________________________________________________



  The Linux distribution packages may use different file names for each
  kind of file mentioned here; they will still contain about the same
  things.


  The `directory' line tells named where to look for files.  All files
  named subsequently will be relative to this.  Thus pz is a directory
  under /var/named, i.e., /var/named/pz.  /var/named is the right
  directory according to the Linux File system Standard.


  The file named /var/named/root.hints is named in this.
  /var/named/root.hints should contain this:



  ______________________________________________________________________
  ;
  ; There might be opening comments here if you already have this file.
  ; If not don't worry.
  ;
  ; About any leading spaces in front of the lines here: remove them!
  ; Lines should start in a ;, . or character, not blanks.
  ;
  .                       6D  IN      NS      A.ROOT-SERVERS.NET.
  .                       6D  IN      NS      B.ROOT-SERVERS.NET.
  .                       6D  IN      NS      C.ROOT-SERVERS.NET.
  .                       6D  IN      NS      D.ROOT-SERVERS.NET.
  .                       6D  IN      NS      E.ROOT-SERVERS.NET.
  .                       6D  IN      NS      F.ROOT-SERVERS.NET.
  .                       6D  IN      NS      G.ROOT-SERVERS.NET.
  .                       6D  IN      NS      H.ROOT-SERVERS.NET.
  .                       6D  IN      NS      I.ROOT-SERVERS.NET.
  .                       6D  IN      NS      J.ROOT-SERVERS.NET.
  .                       6D  IN      NS      K.ROOT-SERVERS.NET.
  .                       6D  IN      NS      L.ROOT-SERVERS.NET.
  .                       6D  IN      NS      M.ROOT-SERVERS.NET.
  A.ROOT-SERVERS.NET.     6D  IN      A       198.41.0.4
  B.ROOT-SERVERS.NET.     6D  IN      A       128.9.0.107
  C.ROOT-SERVERS.NET.     6D  IN      A       192.33.4.12
  D.ROOT-SERVERS.NET.     6D  IN      A       128.8.10.90
  E.ROOT-SERVERS.NET.     6D  IN      A       192.203.230.10
  F.ROOT-SERVERS.NET.     6D  IN      A       192.5.5.241
  G.ROOT-SERVERS.NET.     6D  IN      A       192.112.36.4
  H.ROOT-SERVERS.NET.     6D  IN      A       128.63.2.53
  I.ROOT-SERVERS.NET.     6D  IN      A       192.36.148.17
  J.ROOT-SERVERS.NET.     6D  IN      A       198.41.0.10
  K.ROOT-SERVERS.NET.     6D  IN      A       193.0.14.129
  L.ROOT-SERVERS.NET.     6D  IN      A       198.32.64.12
  M.ROOT-SERVERS.NET.     6D  IN      A       202.12.27.33
  ______________________________________________________________________



  The file describes the root name servers in the world.  The servers
  change over time and must be maintained now and then.  See the
  ``maintenance section'' for how to keep it up to date.


  The next section in named.conf is the last zone.  I will explain its
  use in a later chapter; for now just make this a file named 127.0.0 in
  the subdirectory pz: (Again, please remove leading spaces if you cut
  and paste this)


  ______________________________________________________________________
  $TTL 3D
  @               IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                                  1       ; Serial
                                  8H      ; Refresh
                                  2H      ; Retry
                                  4W      ; Expire
                                  1D)     ; Minimum TTL
                          NS      ns.linux.bogus.
  1                       PTR     localhost.
  ______________________________________________________________________



  The sections called key and controls together specify that your named
  can be remotely controlled by a program called rndc if it connects
  from the local host, and identifis itself with the encoded secret key.
  This key is like a password.  For rndc to work you need /etc/rndc.conf
  to match this:


  ______________________________________________________________________
  key rndc_key {
      algorithm "hmac-md5";
      secret "c3Ryb25nIGVub3VnaCBmb3IgYSBtYW4gYnV0IG1hZGUgZm9yIGEgd29tYW4K";
  };

  options {
      default-server localhost;
      default-key    rndc_key;
  };
  ______________________________________________________________________



  As you see the secret is identical.  If you want to use rndc from
  other machines their times need to be within 5 minutes of eachother.
  I recommend using the ntp (xntpd and ntpdate) software to do this.


  Next, you need a /etc/resolv.conf looking something like this: (Again:
  Remove spaces!)


  ______________________________________________________________________
  search subdomain.your-domain.edu your-domain.edu
  nameserver 127.0.0.1
  ______________________________________________________________________



  The `search' line specifies what domains should be searched for any
  host names you want to connect to.  The `nameserver' line specifies
  the address of your nameserver, in this case your own machine since
  that is where your named runs (127.0.0.1 is right, no matter if your
  machine has another address too).  If you want to list several name
  servers put in one `nameserver' line for each. (Note: Named never
  reads this file, the resolver that uses named does. Note 2: In some
  resolv.conf files you find a line saying "domain".  That's fine, but
  don't use both "search" and "domain", only one of them will work).


  To illustrate what this file does: If a client tries to look up foo,
  then foo.subdomain.your-domain.edu is tried first, then foo.your-
  domain.edu, and finally foo.  You may not want to put in too many
  domains in the search line, as it takes time to search them all.


  The example assumes you belong in the domain subdomain.your-
  domain.edu; your machine, then, is probably called your-
  machine.subdomain.your-domain.edu.  The search line should not contain
  your TLD (Top Level Domain, `edu' in this case).  If you frequently
  need to connect to hosts in another domain you can add that domain to
  the search line like this: (Remember to remove the leading spaces, if
  any)



  ______________________________________________________________________
  search subdomain.your-domain.edu your-domain.edu other-domain.com
  ______________________________________________________________________



  and so on. Obviously you need to put real domain names in instead.
  Please note the lack of periods at the end of the domain names.  This
  is important; please note the lack of periods at the end of the domain
  names.


  3.1.  Starting named

  After all this it's time to start named.  If you're using a dialup
  connection connect first.  Now run named, either by running the boot
  script: /etc/init.d/named start or named directly: /usr/sbin/named.
  If you have tried previous versions of BIND you're probably used to
  ndc.  I BIND 9 it has been replaced with rndc, which can controll your
  named remotely, but it can't start named anymore. If you view your
  syslog message file (usually called /var/log/messages, Debian calls it
  /var/log/daemon, another directory to look is the other files
  /var/log) while starting named (do tail -f /var/log/messages) you
  should see something like:


  (the lines ending in \ continues on the next line)



       Dec 23 02:21:12 lookfar named[11031]: starting BIND 9.1.3
       Dec 23 02:21:12 lookfar named[11031]: using 1 CPU
       Dec 23 02:21:12 lookfar named[11034]: loading configuration from \
           '/etc/named.conf'
       Dec 23 02:21:12 lookfar named[11034]: the default for the \
           'auth-nxdomain' option is now 'no'
       Dec 23 02:21:12 lookfar named[11034]: no IPv6 interfaces found
       Dec 23 02:21:12 lookfar named[11034]: listening on IPv4 interface lo, \
           127.0.0.1#53
       Dec 23 02:21:12 lookfar named[11034]: listening on IPv4 interface eth0, \
           10.0.0.129#53
       Dec 23 02:21:12 lookfar named[11034]: command channel listening on \
           127.0.0.1#953
       Dec 23 02:21:13 lookfar named[11034]: running



  If there are any messages about errors then there is a mistake.  Named
  will name the file it is reading.  Go back and check the file.  Start
  named over when it is fixed.


  Now you can test your setup.  Traditionally a program called nslookup
  is used for this.  These days dig is recommended:



  $ dig -x 127.0.0.1
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 26669
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 0

  ;; QUESTION SECTION:
  ;1.0.0.127.in-addr.arpa.                IN      PTR

  ;; ANSWER SECTION:
  1.0.0.127.in-addr.arpa. 259200  IN      PTR     localhost.

  ;; AUTHORITY SECTION:
  0.0.127.in-addr.arpa.   259200  IN      NS      ns.linux.bogus.

  ;; Query time: 3 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 02:26:17 2001
  ;; MSG SIZE  rcvd: 91



  If that's what you get it's working.  We hope.  Anything very
  different, go back and check everything.  Each time you change a file
  you need to run rndc reload.


  Now you can enter a query.  Try looking up some machine close to you.
  pat.uio.no is close to me, at the University of Oslo:



       $ dig pat.uio.no
       ; <<>> DiG 9.1.3 <<>> pat.uio.no
       ;; global options:  printcmd
       ;; Got answer:
       ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 15574
       ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 0

       ;; QUESTION SECTION:
       ;pat.uio.no.                    IN      A

       ;; ANSWER SECTION:
       pat.uio.no.             86400   IN      A       129.240.130.16

       ;; AUTHORITY SECTION:
       uio.no.                 86400   IN      NS      nissen.uio.no.
       uio.no.                 86400   IN      NS      nn.uninett.no.
       uio.no.                 86400   IN      NS      ifi.uio.no.

       ;; Query time: 651 msec
       ;; SERVER: 127.0.0.1#53(127.0.0.1)
       ;; WHEN: Sun Dec 23 02:28:35 2001
       ;; MSG SIZE  rcvd: 108



  This time dig asked your named to look for the machine pat.uio.no.  It
  then contacted one of the name server machines named in your
  root.hints file, and asked its way from there.  It might take tiny
  while before you get the result as it may need to search all the
  domains you named in /etc/resolv.conf.

  If you ask the same again you get this:



       $ dig pat.uio.no

       ; <<>> DiG 8.2 <<>> pat.uio.no
       ;; res options: init recurs defnam dnsrch
       ;; got answer:
       ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4
       ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 3
       ;; QUERY SECTION:
       ;;      pat.uio.no, type = A, class = IN

       ;; ANSWER SECTION:
       pat.uio.no.             23h59m58s IN A  129.240.130.16

       ;; AUTHORITY SECTION:
       UIO.NO.                 23h59m58s IN NS  nissen.UIO.NO.
       UIO.NO.                 23h59m58s IN NS  ifi.UIO.NO.
       UIO.NO.                 23h59m58s IN NS  nn.uninett.NO.

       ;; ADDITIONAL SECTION:
       nissen.UIO.NO.          23h59m58s IN A  129.240.2.3
       ifi.UIO.NO.             1d23h59m58s IN A  129.240.64.2
       nn.uninett.NO.          1d23h59m58s IN A  158.38.0.181

       ;; Total query time: 4 msec
       ;; FROM: lookfar to SERVER: default -- 127.0.0.1
       ;; WHEN: Sat Dec 16 00:23:09 2000
       ;; MSG SIZE  sent: 28  rcvd: 162



  As you can plainly see this time it was much faster, 4ms versus more
  than half a second earlier.  The answer was cached.  With cached
  answers there is the possibility that the answer is out of date, but
  the origin servers can control the time cached answers should be
  considered valid, so there is a high probability that the answer you
  get is valid.


  3.2.  Resolvers

  All OSes implementing the standard C API has the calls gethostbyname
  and gethostbyaddr.  These can get information from several different
  sources.  Which sources it gets it from is configured in
  /etc/nsswitch.conf on Linux (and some other Unixes).  This is a long
  file specifying from which file or database to get different kinds of
  data types.  It usually contains helpful comments at the top, which
  you should consider reading.  After that find the line starting with
  `hosts:'; it should read:


  ______________________________________________________________________
  hosts:      files dns
  ______________________________________________________________________



  (You remembered about the leading spaces, right? I won't mention them
  again.)

  If there is no line starting with `hosts:' then put in the one above.
  It says that programs should first look in the /etc/hosts file, then
  check DNS according to resolv.conf.



  3.3.  Congratulations

  Now you know how to set up a caching named.  Take a beer, milk, or
  whatever you prefer to celebrate it.



  4.  Forwarding

  In large, well organized, academic or ISP (Internet Service Provider)
  networks you will sometimes find that the network people have set up a
  forwarder hierarchy of DNS servers which helps lighten the internal
  network load and the load on the outside servers as well.  It's not
  easy to know if you're inside such a network or not.  But by using the
  DNS server of your network provider as a ``forwarder'' you can make
  the responses to queries faster and less of a load on your network.
  This works by your nameserver forwarding queries to your ISP
  nameserver.  Each time this happens you will dip into the big cache of
  your ISPs nameserver, thus speeding your queries up, your nameserver
  does not have to do all the work itself.  If you use a modem this can
  be quite a win.  For the sake of this example we assume that your
  network provider has two name servers they want you to use, with IP
  numbers 10.0.0.1 and 10.1.0.1.  Then, in your named.conf file, inside
  the opening section called ``options'', insert these lines:


  ______________________________________________________________________
             forward first;
             forwarders {
                  10.0.0.1;
                  10.1.0.1;
              };
  ______________________________________________________________________



  There is also a nice trick for dialup machines using forwarders, it is
  described in the ``qanda'' section.


  Restart your nameserver and test it with dig.  Should still work fine.


  5.  A simple  domain.

  How to set up your own domain.


  5.1.  But first some dry theory

  First of all: you read all the stuff before here right? You have to.


  Before we really start this section I'm going to serve you some theory
  on and an example of how DNS works.  And you're going to read it
  because it's good for you.  If you don't want to you should at least
  skim it very quickly.  Stop skimming when you get to what should go in
  your named.conf file.

  DNS is a hierarchical, tree structured system.  The top is written `.'
  and pronounced `root', as is usual for tree data-structures.  Under .
  there are a number of Top Level Domains (TLDs); the best known ones
  are ORG, COM, EDU and NET, but there are many more.  Just like a tree
  it has a root and it branches out.  If you have any computer science
  background you will recognize DNS as a search tree, and you will be
  able to find nodes, leaf nodes and edges.  The dots are nodes, the
  edges are on the names.


  When looking for a machine the query proceeds recursively into the
  hierarchy starting at the root.  If you want to find the address of
  prep.ai.mit.edu., your nameserver has to start asking somewhere.  It
  starts by looking it its cache.  If it knows the answer, having cached
  it before, it will answer right away as we saw in the last section.
  If it does not know it will see how closely it can match the requested
  name and use whatever information it has cached.  In the worst case
  there is no match but the `.' (root) of the name, and the root servers
  have to be consulted.  It will remove the leftmost parts one at a
  time, checking if it knows anything about ai.mit.edu., then mit.edu.,
  then edu., and if not that it does know about . because that was in
  the hints file.  It will then ask a .  server about prep.ai.mit.edu.
  This . server will not know the answer, but it will help your server
  on its way by giving a referral, telling it where to look instead.
  These referrals will eventually lead your server to a nameserver that
  knows the answer.  I will illustrate that now.  +norec means that dig
  is asking non-recursive questions so that we get to do the recursion
  ourselves.  The other options are to reduce the amount of dig produces
  so this won't go on for too many pages:



       $ ;; Got answer:
       ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 980
       ;; flags: qr ra; QUERY: 1, ANSWER: 0, AUTHORITY: 13, ADDITIONAL: 0

       ;; AUTHORITY SECTION:
       .                       518400  IN      NS      J.ROOT-SERVERS.NET.
       .                       518400  IN      NS      K.ROOT-SERVERS.NET.
       .                       518400  IN      NS      L.ROOT-SERVERS.NET.
       .                       518400  IN      NS      M.ROOT-SERVERS.NET.
       .                       518400  IN      NS      A.ROOT-SERVERS.NET.
       .                       518400  IN      NS      B.ROOT-SERVERS.NET.
       .                       518400  IN      NS      C.ROOT-SERVERS.NET.
       .                       518400  IN      NS      D.ROOT-SERVERS.NET.
       .                       518400  IN      NS      E.ROOT-SERVERS.NET.
       .                       518400  IN      NS      F.ROOT-SERVERS.NET.
       .                       518400  IN      NS      G.ROOT-SERVERS.NET.
       .                       518400  IN      NS      H.ROOT-SERVERS.NET.
       .                       518400  IN      NS      I.ROOT-SERVERS.NET.



  This is a referral. It is giving us an "Authority section" only, no
  "Answer section". Our own nameserver refers us to a nameserver.  Pick
  one at random:



  $ dig +norec +noques +nostats +nocmd prep.ai.mit.edu. @D.ROOT-SERVERS.NET.
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58260
  ;; flags: qr; QUERY: 1, ANSWER: 0, AUTHORITY: 3, ADDITIONAL: 3

  ;; AUTHORITY SECTION:
  mit.edu.                172800  IN      NS      BITSY.mit.edu.
  mit.edu.                172800  IN      NS      STRAWB.mit.edu.
  mit.edu.                172800  IN      NS      W20NS.mit.edu.

  ;; ADDITIONAL SECTION:
  BITSY.mit.edu.          172800  IN      A       18.72.0.3
  STRAWB.mit.edu.         172800  IN      A       18.71.0.151
  W20NS.mit.edu.          172800  IN      A       18.70.0.160



  It refers us to MIT.EDU servers at once.  Again pick one at random:



       $ dig +norec +noques +nostats +nocmd prep.ai.mit.edu. @BITSY.mit.edu.
       ;; Got answer:
       ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 29227
       ;; flags: qr ra; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 4

       ;; ANSWER SECTION:
       prep.ai.mit.edu.        10562   IN      A       198.186.203.77

       ;; AUTHORITY SECTION:
       ai.mit.edu.             21600   IN      NS      FEDEX.ai.mit.edu.
       ai.mit.edu.             21600   IN      NS      LIFE.ai.mit.edu.
       ai.mit.edu.             21600   IN      NS      ALPHA-BITS.ai.mit.edu.
       ai.mit.edu.             21600   IN      NS      BEET-CHEX.ai.mit.edu.

       ;; ADDITIONAL SECTION:
       FEDEX.ai.mit.edu.       21600   IN      A       192.148.252.43
       LIFE.ai.mit.edu.        21600   IN      A       128.52.32.80
       ALPHA-BITS.ai.mit.edu.  21600   IN      A       128.52.32.5
       BEET-CHEX.ai.mit.edu.   21600   IN      A       128.52.32.22



  This time we got a "ANSWER SECTION", and an answer for our question.
  The "AUTHORITY SECTION" contains information about which servers to
  ask about ai.mit.edu the next time.  So you can ask them directly the
  next time you wonder about ai.mit.edu names.  Named also gathered
  information about mit.edu, so of www.mit.edu is requested it is much
  closer to being able to answer the question.


  So starting at . we found the successive name servers for each level
  in the domain name by referral.  If you had used your own DNS server
  instead of using all those other servers, your named would of-course
  cache all the information it found while digging this out for you, and
  it would not have to ask again for a while.


  In the tree analogue each ``.'' in the name is a branching point.  And
  each part between the ``.''s are the names of individual branches in
  the tree.  One climbs the tree by taking the name we want
  (prep.ai.mit.edu) asking the root (.) or whatever servers father from
  the root toward prep.ai.mit.edu we have information about in the
  cache.  Once the cache limits are reached the recursive resolver goes
  out asking servers, pursuing referrals (edges) further into the name.


  A much less talked about, but just as important domain is in-
  addr.arpa.  It too is nested like the `normal' domains.  in-addr.arpa
  allows us to get the host's name when we have its address.  A
  important thing to note here is that the IP addresses are written in
  reverse order in the in-addr.arpa domain.  If you have the address of
  a machine: 198.186.203.77 named proceeds to find the named
  77.203.168.198.in-addr.arpa/ just like it did for prep.ai.mit.edu.
  Example: Finding no cache entry for any match but `.', ask a root
  server, m.root-servers.net refers you to some other root servers.
  b.root-servers.net refers you directly to bitsy.mit.edu/.  You should
  be able to take it from there.



  5.2.  Our own domain

  Now to define our own domain.  We're going to make the domain
  linux.bogus and define machines in it.  I use a totally bogus domain
  name to make sure we disturb no-one Out There.


  One more thing before we start: Not all characters are allowed in host
  names.  We're restricted to the characters of the English alphabet: a-
  z, and numbers 0-9 and the character '-' (dash).  Keep to those
  characters (BIND 9 will not bug you if you break this rule, BIND 8
  will). Upper and lower-case characters are the same for DNS, so
  pat.uio.no is identical to Pat.UiO.No.


  We've already started this part with this line in named.conf:


  ______________________________________________________________________
  zone "0.0.127.in-addr.arpa" {
          type master;
          file "pz/127.0.0";
  };
  ______________________________________________________________________



  Please note the lack of `.' at the end of the domain names in this
  file.  This says that now we will define the zone 0.0.127.in-
  addr.arpa, that we're the master server for it and that it is stored
  in a file called pz/127.0.0.  We've already set up this file, it
  reads:


  ______________________________________________________________________
  $TTL 3D
  @               IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                                  1       ; Serial
                                  8H      ; Refresh
                                  2H      ; Retry
                                  4W      ; Expire
                                  1D)     ; Minimum TTL
                          NS      ns.linux.bogus.
  1                       PTR     localhost.
  ______________________________________________________________________

  Please note the `.' at the end of all the full domain names in this
  file, in contrast to the named.conf file above. Some people like to
  start each zone file with a $ORIGIN directive, but this is
  superfluous.  The origin (where in the DNS hierarchy it belongs) of a
  zone file is specified in the zone section of the named.conf file; in
  this case it's 0.0.127.in-addr.arpa.


  This `zone file' contains 3 `resource records' (RRs): A SOA RR.  A NS
  RR and a PTR RR.  SOA is short for Start Of Authority.  The `@' is a
  special notation meaning the origin, and since the `domain' column for
  this file says 0.0.127.in-addr.arpa the first line really means



       0.0.127.in-addr.arpa.   IN      SOA ...



  NS is the Name Server RR.  There is no '@' at the start of this line;
  it is implicit since the previous line started with a '@'.  Saves some
  typing that.  So the NS line could also be written



       0.0.127.in-addr.arpa.   IN      NS      ns.linux.bogus



  It tells DNS what machine is the name server of the domain 0.0.127.in-
  addr.arpa, it is ns.linux.bogus.  'ns' is a customary name for name-
  servers, but as with web servers who are customarily named
  www.something. The name may be anything.


  And finally the PTR (Domain Name Pointer) record says that the host at
  address 1 in the subnet 0.0.127.in-addr.arpa, i.e., 127.0.0.1 is named
  localhost.


  The SOA record is the preamble to all zone files, and there should be
  exactly one in each zone file, at the top (but after the $TTL
  directive).  It describes the zone, where it comes from (a machine
  called ns.linux.bogus), who is responsible for its contents
  (hostmaster@linux.bogus; you should insert your e-mail address here),
  what version of the zone file this is (serial: 1), and other things
  having to do with caching and secondary DNS servers.  For the rest of
  the fields (refresh, retry, expire and minimum) use the numbers used
  in this HOWTO and you should be safe.  Before the SOA comes a
  mandatory line, the $TTL 3D line.  Put it in all your zone files.


  Now restart your named (rndc stop; named) and use dig to examine your
  handy work.  -x asks for the inverse query:



  $ dig -x 127.0.0.1
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 30944
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 0

  ;; QUESTION SECTION:
  ;1.0.0.127.in-addr.arpa.                IN      PTR

  ;; ANSWER SECTION:
  1.0.0.127.in-addr.arpa. 259200  IN      PTR     localhost.

  ;; AUTHORITY SECTION:
  0.0.127.in-addr.arpa.   259200  IN      NS      ns.linux.bogus.

  ;; Query time: 3 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 03:02:39 2001
  ;; MSG SIZE  rcvd: 91



  So it manages to get localhost from 127.0.0.1, good.  Now for our main
  task, the linux.bogus domain, insert a new 'zone' section in
  named.conf:


  ______________________________________________________________________
  zone "linux.bogus" {
          type master;
          notify no;
          file "pz/linux.bogus";
  };
  ______________________________________________________________________



  Note again the lack of ending `.' on the domain name in the named.conf
  file.


  In the linux.bogus zone file we'll put some totally bogus data:



  ______________________________________________________________________
  ;
  ; Zone file for linux.bogus
  ;
  ; The full zone file
  ;
  $TTL 3D
  @       IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                          199802151       ; serial, todays date + todays serial #
                          8H              ; refresh, seconds
                          2H              ; retry, seconds
                          4W              ; expire, seconds
                          1D )            ; minimum, seconds
  ;
                  NS      ns              ; Inet Address of name server
                  MX      10 mail.linux.bogus     ; Primary Mail Exchanger
                  MX      20 mail.friend.bogus.   ; Secondary Mail Exchanger
  ;
  localhost       A       127.0.0.1
  ns              A       192.168.196.2
  mail            A       192.168.196.4
  ______________________________________________________________________



  Two things must be noted about the SOA record.  ns.linux.bogus must be
  a actual machine with a A record.  It is not legal to have a CNAME
  record for the machine mentioned in the SOA record.  Its name need not
  be `ns', it could be any legal host name.  Next,
  hostmaster.linux.bogus should be read as hostmaster@linux.bogus.  This
  should be a mail alias, or a mailbox, where the person(s) maintaining
  DNS should read mail frequently.  Any mail regarding the domain will
  be sent to the address listed here.  The name need not be
  `hostmaster', it can be your normal e-mail address, but the e-mail
  address `hostmaster' is often expected to work as well.


  There is one new RR type in this file, the MX, or Mail eXchanger RR.
  It tells mail systems where to send mail that is addressed to
  someone@linux.bogus, namely to mail.linux.bogus or mail.friend.bogus.
  The number before each machine name is that MX RR's priority.  The RR
  with the lowest number (10) is the one mail should be sent to if
  possible.  If that fails the mail can be sent to one with a higher
  number, a secondary mail handler, i.e., mail.friend.bogus which has
  priority 20 here.


  Reload named by running rndc reload.  Examine the results with dig:



  $ dig any linux.bogus
  ; <<>> DiG 9.1.3 <<>> any linux.bogus
  ;; global options:  printcmd
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 55239
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 1, ADDITIONAL: 1

  ;; QUESTION SECTION:
  ;linux.bogus.               IN      ANY

  ;; ANSWER SECTION:
  linux.bogus.        259200  IN      SOA     ns.linux.bogus. \
        hostmaster.linux.bogus. 199802151 28800 7200 2419200 86400
  linux.bogus.        259200  IN      NS      ns.linux.bogus.
  linux.bogus.        259200  IN      MX      20 mail.friend.bogus.
  linux.bogus.        259200  IN      MX      10 mail.linux.bogus.linux.bogus.

  ;; AUTHORITY SECTION:
  linux.bogus.        259200  IN      NS      ns.linux.bogus.

  ;; ADDITIONAL SECTION:
  ns.linux.bogus.     259200  IN      A       192.168.196.2

  ;; Query time: 4 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 03:06:45 2001
  ;; MSG SIZE  rcvd: 184



  Upon careful examination you will discover a bug.  The line



       linux.bogus.        259200  IN MX        10 mail.linux.bogus.linux.bogus.



  is all wrong.  It should be



       linux.bogus.        259200  IN MX        10 mail.linux.bogus.



  I deliberately made a mistake so you could learn from it :-) Looking
  in the zone file we find this line:



                       MX      10 mail.linux.bogus     ; Primary Mail Exchanger



  It is missing a period.  Or has a 'linux.bogus' too many.  If a
  machine name does not end in a period in a zone file the origin is
  added to its end causing the double linux.bogus.linux.bogus.  So
  either


  ______________________________________________________________________
                  MX      10 mail.linux.bogus.    ; Primary Mail Exchanger
  ______________________________________________________________________



  or


  ______________________________________________________________________
                  MX      10 mail                 ; Primary Mail Exchanger
  ______________________________________________________________________



  is correct.  I prefer the latter form, it's less to type.  There are
  some BIND experts that disagree, and some that agree with this.  In a
  zone file the domain should either be written out and ended with a `.'
  or it should not be included at all, in which case it defaults to the
  origin.


  I must stress that in the named.conf file there should not be `.'s
  after the domain names.  You have no idea how many times a `.' too
  many or few have fouled up things and confused the h*ll out of people.


  So having made my point here is the new zone file, with some extra
  information in it as well:



  ______________________________________________________________________
  ;
  ; Zone file for linux.bogus
  ;
  ; The full zone file
  ;
  $TTL 3D
  @       IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                          199802151       ; serial, todays date + todays serial #
                          8H              ; refresh, seconds
                          2H              ; retry, seconds
                          4W              ; expire, seconds
                          1D )            ; minimum, seconds
  ;
                  TXT     "Linux.Bogus, your DNS consultants"
                  NS      ns              ; Inet Address of name server
                  NS      ns.friend.bogus.
                  MX      10 mail         ; Primary Mail Exchanger
                  MX      20 mail.friend.bogus. ; Secondary Mail Exchanger

  localhost       A       127.0.0.1

  gw              A       192.168.196.1
                  TXT     "The router"

  ns              A       192.168.196.2
                  MX      10 mail
                  MX      20 mail.friend.bogus.
  www             CNAME   ns

  donald          A       192.168.196.3
                  MX      10 mail
                  MX      20 mail.friend.bogus.
                  TXT     "DEK"

  mail            A       192.168.196.4
                  MX      10 mail
                  MX      20 mail.friend.bogus.

  ftp             A       192.168.196.5
                  MX      10 mail
                  MX      20 mail.friend.bogus.
  ______________________________________________________________________



  CNAME (Canonical NAME) is a way to give each machine several names.
  So www is an alias for ns.  CNAME record usage is a bit controversial.
  But it's safe to follow the rule that a MX, CNAME or SOA record should
  never refer to a CNAME record, they should only refer to something
  with an A record, so it is inadvisable to have


  ______________________________________________________________________
  foobar          CNAME   www                     ; NO!
  ______________________________________________________________________



  but correct to have



  ______________________________________________________________________
  foobar          CNAME   ns                      ; Yes!
  ______________________________________________________________________



  Load the new database by running rndc reload, which causes named to
  read its files again.



       $ dig linux.bogus axfr

       ; <<>> DiG 9.1.3 <<>> linux.bogus axfr
       ;; global options:  printcmd
       linux.bogus.            259200  IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. 199802151 28800 7200 2419200 86400
       linux.bogus.            259200  IN      NS      ns.linux.bogus.
       linux.bogus.            259200  IN      MX      10 mail.linux.bogus.
       linux.bogus.            259200  IN      MX      20 mail.friend.bogus.
       donald.linux.bogus.     259200  IN      A       192.168.196.3
       donald.linux.bogus.     259200  IN      MX      10 mail.linux.bogus.
       donald.linux.bogus.     259200  IN      MX      20 mail.friend.bogus.
       donald.linux.bogus.     259200  IN      TXT     "DEK"
       ftp.linux.bogus.        259200  IN      A       192.168.196.5
       ftp.linux.bogus.        259200  IN      MX      10 mail.linux.bogus.
       ftp.linux.bogus.        259200  IN      MX      20 mail.friend.bogus.
       gw.linux.bogus.         259200  IN      A       192.168.196.1
       gw.linux.bogus.         259200  IN      TXT     "The router"
       localhost.linux.bogus.  259200  IN      A       127.0.0.1
       mail.linux.bogus.       259200  IN      A       192.168.196.4
       mail.linux.bogus.       259200  IN      MX      10 mail.linux.bogus.
       mail.linux.bogus.       259200  IN      MX      20 mail.friend.bogus.
       ns.linux.bogus.         259200  IN      MX      10 mail.linux.bogus.
       ns.linux.bogus.         259200  IN      MX      20 mail.friend.bogus.
       ns.linux.bogus.         259200  IN      A       192.168.196.2
       www.linux.bogus.        259200  IN      CNAME   ns.linux.bogus.
       linux.bogus.            259200  IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. 199802151 28800 7200 2419200 86400
       ;; Query time: 41 msec
       ;; SERVER: 127.0.0.1#53(127.0.0.1)
       ;; WHEN: Sun Dec 23 03:12:31 2001
       ;; XFR size: 23 records



  That's good.  As you see it looks a bit like the zone file itself.
  Let's check what it says for www alone:



  $ dig www.linux.bogus

  ; <<>> DiG 9.1.3 <<>> www.linux.bogus
  ;; global options:  printcmd
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16633
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 0

  ;; QUESTION SECTION:
  ;www.linux.bogus.               IN      A

  ;; ANSWER SECTION:
  www.linux.bogus.        259200  IN      CNAME   ns.linux.bogus.
  ns.linux.bogus.         259200  IN      A       192.168.196.2

  ;; AUTHORITY SECTION:
  linux.bogus.            259200  IN      NS      ns.linux.bogus.

  ;; Query time: 5 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 03:14:14 2001
  ;; MSG SIZE  rcvd: 80



  In other words, the real name of www.linux.bogus is ns.linux.bogus,
  and it gives you some of the information it has about ns as well,
  enough to connect to it if you were a program.


  Now we're halfway.


  5.3.  The reverse zone

  Now programs can convert the names in linux.bogus to addresses which
  they can connect to. But also required is a reverse zone, one making
  DNS able to convert from an address to a name. This name is used by a
  lot of servers of different kinds (FTP, IRC, WWW and others) to decide
  if they want to talk to you or not, and if so, maybe even how much
  priority you should be given. For full access to all services on the
  Internet a reverse zone is required.


  Put this in named.conf:


  ______________________________________________________________________
  zone "196.168.192.in-addr.arpa" {
          type master;
          notify no;
          file "pz/192.168.196";
  };
  ______________________________________________________________________



  This is exactly as with the 0.0.127.in-addr.arpa, and the contents are
  similar:



  ______________________________________________________________________
  $TTL 3D
  @       IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                          199802151 ; Serial, todays date + todays serial
                          8H      ; Refresh
                          2H      ; Retry
                          4W      ; Expire
                          1D)     ; Minimum TTL
                  NS      ns.linux.bogus.

  1               PTR     gw.linux.bogus.
  2               PTR     ns.linux.bogus.
  3               PTR     donald.linux.bogus.
  4               PTR     mail.linux.bogus.
  5               PTR     ftp.linux.bogus.
  ______________________________________________________________________



  Now you reload your named (rndc reload) and examine your work with dig
  again:


  ______________________________________________________________________
  $ dig -x 192.168.196.4
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58451
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1

  ;; QUESTION SECTION:
  ;4.196.168.192.in-addr.arpa.    IN      PTR

  ;; ANSWER SECTION:
  4.196.168.192.in-addr.arpa. 259200 IN   PTR     mail.linux.bogus.

  ;; AUTHORITY SECTION:
  196.168.192.in-addr.arpa. 259200 IN     NS      ns.linux.bogus.

  ;; ADDITIONAL SECTION:
  ns.linux.bogus.         259200  IN      A       192.168.196.2

  ;; Query time: 4 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 03:16:05 2001
  ;; MSG SIZE  rcvd: 107
  ______________________________________________________________________



  so, it looks OK, dump the whole thing to examine that too:



  ______________________________________________________________________
  $ dig 196.168.192.in-addr.arpa. AXFR

  ; <<>> DiG 9.1.3 <<>> 196.168.192.in-addr.arpa. AXFR
  ;; global options:  printcmd
  196.168.192.in-addr.arpa. 259200 IN     SOA     ns.linux.bogus. \
          hostmaster.linux.bogus. 199802151 28800 7200 2419200 86400
  196.168.192.in-addr.arpa. 259200 IN     NS      ns.linux.bogus.
  1.196.168.192.in-addr.arpa. 259200 IN   PTR     gw.linux.bogus.
  2.196.168.192.in-addr.arpa. 259200 IN   PTR     ns.linux.bogus.
  3.196.168.192.in-addr.arpa. 259200 IN   PTR     donald.linux.bogus.
  4.196.168.192.in-addr.arpa. 259200 IN   PTR     mail.linux.bogus.
  5.196.168.192.in-addr.arpa. 259200 IN   PTR     ftp.linux.bogus.
  196.168.192.in-addr.arpa. 259200 IN     SOA     ns.linux.bogus. \
          hostmaster.linux.bogus. 199802151 28800 7200 2419200 86400
  ;; Query time: 6 msec
  ;; SERVER: 127.0.0.1#53(127.0.0.1)
  ;; WHEN: Sun Dec 23 03:16:58 2001
  ;; XFR size: 9 records
  ______________________________________________________________________



  Looks good!  If your output didn't look like that look for error-
  messages in your syslog, I explained how to do that in the first
  section under the heading ``Starting named''


  5.4.  Words of caution

  There are some things I should add here.  The IP numbers used in the
  examples above are taken from one of the blocks of 'private nets',
  i.e., they are not allowed to be used publicly on the Internet.  So
  they are safe to use in an example in a HOWTO.  The second thing is
  the notify no; line.  It tells named not to notify its secondary
  (slave) servers when it has gotten a update to one of its zone files.
  In BIND 8 and later the named can notify the other servers listed in
  NS records in the zone file when a zone is updated.  This is handy for
  ordinary use.  But for private experiments with zones this feature
  should be off --- we don't want the experiment to pollute the Internet
  do we?


  And, of course, this domain is highly bogus, and so are all the
  addresses in it.  For a real example of a real-life domain see the
  next main-section.


  5.5.  Why reverse lookups don't work.

  There are a couple of ``gotchas'' that normally are avoided with name
  lookups that are often seen when setting up reverse zones.  Before you
  go on you need reverse lookups of your machines working on your own
  nameserver.  If it isn't go back and fix it before continuing.


  I will discuss two failures of reverse lookups as seen from outside
  your network:


  5.5.1.  The reverse zone isn't delegated.

  When you ask a service provider for a network-address range and a
  domain name the domain name is normally delegated as a matter of
  course.  A delegation is the glue NS record that helps you get from
  one nameserver to another as explained in the dry theory section
  above.  You read that, right?  If your reverse zone doesn't work go
  back and read it.  Now.


  The reverse zone also needs to be delegated.  If you got the
  192.168.196 net with the linux.bogus domain from your provider they
  need to put NS records in for your reverse zone as well as for your
  forward zone.  If you follow the chain from in-addr.arpa and up to
  your net you will probably find a break in the chain, most probably at
  your service provider.  Having found the break in the chain contact
  your service-provider and ask them to correct the error.


  5.5.2.  You've got a classless subnet

  This is a somewhat advanced topic, but classless subnets are very
  common these days and you probably have one if you're a small company.


  A classless subnet is what keeps the Internet going these days.  Some
  years ago there was much ado about the shortage of IP numbers.  The
  smart people in IETF (the Internet Engineering Task Force, they keep
  the Internet working) stuck their heads together and solved the
  problem.  At a price.  The price is in part that you'll get less than
  a ``C'' subnet and some things may break.  Please see Ask Mr. DNS
  <http://www.acmebw.com/askmrdns/00007.htm> for an good explanation of
  this and how to handle it.


  Did you read it?  I'm not going to explain it so please read it.


  The first part of the problem is that your ISP must understand the
  technique described by Mr. DNS.  Not all small ISPs have a working
  understanding of this.  If so you might have to explain to them and be
  persistent.  But be sure you understand it first ;-).  They will then
  set up a nice reverse zone at their server which you can examine for
  correctness with dig.


  The second and last part of the problem is that you must understand
  the technique.  If you're unsure go back and read about it again.
  Then you can set up your own classless reverse zone as described by
  Mr. DNS.


  There is another trap lurking here.  (Very) Old resolvers will not be
  able to follow the CNAME trick in the resolving chain and will fail to
  reverse-resolve your machine.  This can result in the service
  assigning it an incorrect access class, deny access or something along
  those lines.  If you stumble into such a service the only solution
  (that I know of) is for your ISP to insert your PTR record directly
  into their trick classless zone file instead of the trick CNAME
  record.


  Some ISPs will offer other ways to handle this, like Web based forms
  for you to input your reverse-mappings in or other automagical
  systems.


  5.6.  Slave servers

  Once you have set up your zones correctly on the master servers you
  need to set up at least one slave server.  Slave servers are needed
  for robustness.  If your master goes down the people out there on the
  net will still be able to get information about your domain from the
  slave.  A slave should be as long away from you as possible.  Your
  master and slave should share as few as possible of these: Power
  supply, LAN, ISP, city and country.  If all of these things are
  different for your master and slave you've found a really good slave.


  A slave is simply a nameserver that copies zone files from a master.
  You set it up like this:


  ______________________________________________________________________
  zone "linux.bogus" {
          type slave;
          file "sz/linux.bogus";
          masters { 192.168.196.2; };
  };
  ______________________________________________________________________



  A mechanism called zone-transfer is used to copy the data.  The zone
  transfer is controlled by your SOA record:


  ______________________________________________________________________
  @       IN      SOA     ns.linux.bogus. hostmaster.linux.bogus. (
                          199802151       ; serial, todays date + todays serial #
                          8H              ; refresh, seconds
                          2H              ; retry, seconds
                          4W              ; expire, seconds
                          1D )            ; minimum, seconds
  ______________________________________________________________________



  A zone is only transferred if the serial number on the master is
  larger than on the slave.  Every refresh interval the slave will check
  if the master has been updated.  If the check fails (because the
  master is unavailable) it will retry the check every retry interval.
  If it continues to fail as long as the expire interval the slave will
  remove the zone from it's filesystem and no longer be a server for it.



  6.  Basic security options.

  By Jamie Norrish


  Setting configuration options to reduce the possibility of problems.


  There are a few simple steps that you can take which will both make
  your server more secure and potentially reduce its load. The material
  presented here is nothing more than a starting point; if you are
  concerned about security (and you should be), please consult other
  resources on the net (see ``the last chapter'').


  The following configuration directives occur in named.conf. If a
  directive occurs in the options section of the file, it applies to all
  zones listed in that file. If it occurs within a zone entry, it
  applies only to that zone. A zone entry overrides an options entry.


  6.1.  Restricting zone transfers

  In order for your slave server(s) to be able to answer queries about
  your domain, they must be able to transfer the zone information from
  your primary server.  Very few others have a need to do so.  Therefore
  restrict zone transfers using the allow-transfer option, assuming
  192.168.1.4 is the IP address of ns.friend.bogus and adding yourself
  for debugging purposes:


  ______________________________________________________________________
  zone "linux.bogus" {
        allow-transfer { 192.168.1.4; localhost; };
  };
  ______________________________________________________________________



  By restricting zone transfers you ensure that the only information
  available to people is that which they ask for directly - no one can
  just ask for all the details about your set-up.


  6.2.  Protecting against spoofing

  Firstly, disable any queries for domains you don't own, except from
  your internal/local machines. This not only helps prevent malicious
  use of your DNS server, but also reduces unnecessary use of your
  server.


  ______________________________________________________________________
  options {
        allow-query { 192.168.196.0/24; localhost; };
  };

  zone "linux.bogus" {
        allow-query { any; };
  };

  zone "196.168.192.in-addr.arpa" {
        allow-query { any; };
  };
  ______________________________________________________________________



  Further, disable recursive queries except from internal/local sources.
  This reduces the risk of cache poisoning attacks (where false data is
  fed to your server).


  ______________________________________________________________________
  options {
          allow-recursion { 192.168.196.0/24; localhost; };
  };
  ______________________________________________________________________



  6.3.  Running named as non-root

  It is a good idea to run named as a user other than root, so that if
  it is compromised the privileges gained by the cracker are as limited
  as possible. You first have to create a user for named to run under,
  and then modify whatever init script you use that starts named. Pass
  the new user name and group to named using the -u and -g flags.


  For example, in Debian GNU/Linux 2.2 you might modify your
  /etc/init.d/bind script to have the following line (where user named
  have been created):


  ______________________________________________________________________
  start-stop-daemon --start --quiet --exec /usr/sbin/named -- -u named
  ______________________________________________________________________



  The same can be done with Red Hat and the other distributions.


  Dave Lugo has described a secure dual chroot setup
  <http://www.etherboy.com/dns/chrootdns.html> which you may find
  interesting to read, it makes the host your run your named on even
  more secure.


  7.  A real domain example

  Where we list some real zone files


  Users have suggested that I include a real example of a working domain
  as well as the tutorial example.


  I use this example with permission from David Bullock of LAND-5.
  These files were current 24th of September 1996, and were then edited
  to fit BIND 8 restrictions and use extensions by me.  So, what you see
  here differs a bit from what you find if you query LAND-5's name
  servers now.


  7.1.  /etc/named.conf (or /var/named/named.conf)

  Here we find master zone sections for the two reverse zones needed:
  the 127.0.0 net, as well as LAND-5's 206.6.177 subnet, and a primary
  line for land-5's forward zone land-5.com. Also note that instead of
  stuffing the files in a directory called pz, as I do in this HOWTO, he
  puts them in a directory called zone.



  ______________________________________________________________________
  // Boot file for LAND-5 name server

  options {
          directory "/var/named";
  };

  controls {
          inet 127.0.0.1 allow { localhost; } keys { rndc_key; };
  };

  key "rndc_key" {
          algorithm hmac-md5;
          secret "c3Ryb25nIGVub3VnaCBmb3IgYSBtYW4gYnV0IG1hZGUgZm9yIGEgd29tYW4K";
  };

  zone "." {
          type hint;
          file "root.hints";
  };

  zone "0.0.127.in-addr.arpa" {
          type master;
          file "zone/127.0.0";
  };

  zone "land-5.com" {
          type master;
          file "zone/land-5.com";
  };

  zone "177.6.206.in-addr.arpa" {
          type master;
          file "zone/206.6.177";
  };
  ______________________________________________________________________



  If you put this in your named.conf file to play with PLEASE put
  ``notify no;'' in the zone sections for the two land-5 zones so as to
  avoid accidents.


  7.2.  /var/named/root.hints

  Keep in mind that this file is dynamic, and the one listed here is
  old.  You're better off using a new one as explained earlier.



  ______________________________________________________________________
  ; <<>> DiG 8.1 <<>> @A.ROOT-SERVERS.NET.
  ; (1 server found)
  ;; res options: init recurs defnam dnsrch
  ;; got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10
  ;; flags: qr aa rd; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 13
  ;; QUERY SECTION:
  ;;      ., type = NS, class = IN

  ;; ANSWER SECTION:
  .                     6D IN NS        G.ROOT-SERVERS.NET.
  .                     6D IN NS        J.ROOT-SERVERS.NET.
  .                     6D IN NS        K.ROOT-SERVERS.NET.
  .                     6D IN NS        L.ROOT-SERVERS.NET.
  .                     6D IN NS        M.ROOT-SERVERS.NET.
  .                     6D IN NS        A.ROOT-SERVERS.NET.
  .                     6D IN NS        H.ROOT-SERVERS.NET.
  .                     6D IN NS        B.ROOT-SERVERS.NET.
  .                     6D IN NS        C.ROOT-SERVERS.NET.
  .                     6D IN NS        D.ROOT-SERVERS.NET.
  .                     6D IN NS        E.ROOT-SERVERS.NET.
  .                     6D IN NS        I.ROOT-SERVERS.NET.
  .                     6D IN NS        F.ROOT-SERVERS.NET.

  ;; ADDITIONAL SECTION:
  G.ROOT-SERVERS.NET.     5w6d16h IN A    192.112.36.4
  J.ROOT-SERVERS.NET.     5w6d16h IN A    198.41.0.10
  K.ROOT-SERVERS.NET.     5w6d16h IN A    193.0.14.129
  L.ROOT-SERVERS.NET.     5w6d16h IN A    198.32.64.12
  M.ROOT-SERVERS.NET.     5w6d16h IN A    202.12.27.33
  A.ROOT-SERVERS.NET.     5w6d16h IN A    198.41.0.4
  H.ROOT-SERVERS.NET.     5w6d16h IN A    128.63.2.53
  B.ROOT-SERVERS.NET.     5w6d16h IN A    128.9.0.107
  C.ROOT-SERVERS.NET.     5w6d16h IN A    192.33.4.12
  D.ROOT-SERVERS.NET.     5w6d16h IN A    128.8.10.90
  E.ROOT-SERVERS.NET.     5w6d16h IN A    192.203.230.10
  I.ROOT-SERVERS.NET.     5w6d16h IN A    192.36.148.17
  F.ROOT-SERVERS.NET.     5w6d16h IN A    192.5.5.241

  ;; Total query time: 215 msec
  ;; FROM: roke.uio.no to SERVER: A.ROOT-SERVERS.NET.  198.41.0.4
  ;; WHEN: Sun Feb 15 01:22:51 1998
  ;; MSG SIZE  sent: 17  rcvd: 436
  ______________________________________________________________________



  7.3.  /var/named/zone/127.0.0

  Just the basics, the obligatory SOA record, and a record that maps
  127.0.0.1 to localhost.  Both are required.  No more should be in this
  file.  It will probably never need to be updated, unless your
  nameserver or hostmaster address changes.



  ______________________________________________________________________
  $TTL 3D
  @               IN      SOA     land-5.com. root.land-5.com. (
                                  199609203       ; Serial
                                  28800   ; Refresh
                                  7200    ; Retry
                                  604800  ; Expire
                                  86400)  ; Minimum TTL
                          NS      land-5.com.

  1                       PTR     localhost.
  ______________________________________________________________________



  If you look at a random BIND installation you will probably find that
  the $TTL line is missing as it is here.  It was not used before, and
  only version 8.2 of BIND has started to warn about its absence.  BIND
  9 requires the $TTL.


  7.4.  /var/named/zone/land-5.com

  Here we see the mandatory SOA record, the needed NS records.  We can
  see that he has a secondary name server at ns2.psi.net.  This is as it
  should be, always have a off site secondary server as backup.  We can
  also see that he has a master host called land-5 which takes care of
  many of the different Internet services, and that he's done it with
  CNAMEs (a alternative is using A records).


  As you see from the SOA record, the zone file originates at
  land-5.com, the contact person is root@land-5.com. hostmaster is
  another oft used address for the contact person.  The serial number is
  in the customary yyyymmdd format with todays serial number appended;
  this is probably the sixth version of zone file on the 20th of
  September 1996.  Remember that the serial number must increase
  monotonically, here there is only one digit for todays serial#, so
  after 9 edits he has to wait until tomorrow before he can edit the
  file again.  Consider using two digits.



  ______________________________________________________________________
  $TTL 3D
  @       IN      SOA     land-5.com. root.land-5.com. (
                          199609206       ; serial, todays date + todays serial #
                          8H              ; refresh, seconds
                          2H              ; retry, seconds
                          4W              ; expire, seconds
                          1D )            ; minimum, seconds
                  NS      land-5.com.
                  NS      ns2.psi.net.
                  MX      10 land-5.com.  ; Primary Mail Exchanger
                  TXT     "LAND-5 Corporation"

  localhost       A       127.0.0.1

  router          A       206.6.177.1

  land-5.com.     A       206.6.177.2
  ns              A       206.6.177.3
  www             A       207.159.141.192

  ftp             CNAME   land-5.com.
  mail            CNAME   land-5.com.
  news            CNAME   land-5.com.

  funn            A       206.6.177.2

  ;
  ;       Workstations
  ;
  ws-177200       A       206.6.177.200
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177201       A       206.6.177.201
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177202       A       206.6.177.202
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177203       A       206.6.177.203
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177204       A       206.6.177.204
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177205       A       206.6.177.205
                  MX      10 land-5.com.   ; Primary Mail Host
  ; {Many repetitive definitions deleted - SNIP}
  ws-177250       A       206.6.177.250
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177251       A       206.6.177.251
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177252       A       206.6.177.252
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177253       A       206.6.177.253
                  MX      10 land-5.com.   ; Primary Mail Host
  ws-177254       A       206.6.177.254
                  MX      10 land-5.com.   ; Primary Mail Host
  ______________________________________________________________________



  If you examine land-5s nameserver you will find that the host names
  are of the form ws_number.  As of late BIND 4 versions named started
  enforcing the restrictions on what characters may be used in host
  names.  So that does not work with BIND 8 at all, and I substituted
  '-' (dash) for '_' (underline) for use in this HOWTO.  But, as
  mentioned earlier, BIND 9 no longer enforces this restriction.


  Another thing to note is that the workstations don't have individual
  names, but rather a prefix followed by the two last parts of the IP
  numbers.  Using such a convention can simplify maintenance
  significantly, but can be a bit impersonal, and, in fact, be a source
  of irritation among your customers.


  We also see that funn.land-5.com is an alias for land-5.com, but using
  an A record, not a CNAME record.


  7.5.  /var/named/zone/206.6.177

  I'll comment on this file below


  ______________________________________________________________________
  $TTL 3D
  @               IN      SOA     land-5.com. root.land-5.com. (
                                  199609206       ; Serial
                                  28800   ; Refresh
                                  7200    ; Retry
                                  604800  ; Expire
                                  86400)  ; Minimum TTL
                          NS      land-5.com.
                          NS      ns2.psi.net.
  ;
  ;       Servers
  ;
  1       PTR     router.land-5.com.
  2       PTR     land-5.com.
  2       PTR     funn.land-5.com.
  ;
  ;       Workstations
  ;
  200     PTR     ws-177200.land-5.com.
  201     PTR     ws-177201.land-5.com.
  202     PTR     ws-177202.land-5.com.
  203     PTR     ws-177203.land-5.com.
  204     PTR     ws-177204.land-5.com.
  205     PTR     ws-177205.land-5.com.
  ; {Many repetitive definitions deleted - SNIP}
  250     PTR     ws-177250.land-5.com.
  251     PTR     ws-177251.land-5.com.
  252     PTR     ws-177252.land-5.com.
  253     PTR     ws-177253.land-5.com.
  254     PTR     ws-177254.land-5.com.
  ______________________________________________________________________



  The reverse zone is the bit of the setup that seems to cause the most
  grief.  It is used to find the host name if you have the IP number of
  a machine.  Example: you are an FTP server and accept connections from
  FTP clients.  As you are a Norwegian FTP server you want to accept
  more connections from clients in Norway and other Scandinavian
  countries and less from the rest of the world.  When you get a
  connection from a client the C library is able to tell you the IP
  number of the connecting machine because the IP number of the client
  is contained in all the packets that are passed over the network.  Now
  you can call a function called gethostbyaddr that looks up the name of
  a host given the IP number.  Gethostbyaddr will ask a DNS server,
  which will then traverse the DNS looking for the machine.  Supposing
  the client connection is from ws-177200.land-5.com.  The IP number the
  C library provides to the FTP server is 206.6.177.200.  To find out
  the name of that machine we need to find 200.177.6.206.in-addr.arpa.
  The DNS server will first find the arpa. servers, then find in-
  addr.arpa. servers, following the reverse trail through 206, then 6
  and at last finding the server for the 177.6.206.in-addr.arpa zone at
  LAND-5.  From which it will finally get the answer that for
  200.177.6.206.in-addr.arpa we have a ``PTR ws-177200.land-5.com''
  record, meaning that the name that goes with 206.6.177.200 is
  ws-177200.land-5.com.


  The FTP server prioritizes connections from the Scandinavian
  countries, i.e., *.no, *.se, *.dk, the name ws-177200.land-5.com
  clearly does not match any of those, and the server will put the
  connection in a connection class with less bandwidth and fewer clients
  allowed.  If there was no reverse mapping of 206.2.177.200 through the
  in-addr.arpa zone the server would have been unable to find the name
  at all and would have to settle to comparing 206.2.177.200 with *.no,
  *.se and *.dk, none of which will match at all, it may even deny the
  connection for lack of classification.


  Some people will tell you that reverse lookup mappings are only
  important for servers, or not important at all.  Not so: Many ftp,
  news, IRC and even some http (WWW) servers will not accept connections
  from machines of which they are not able to find the name.  So reverse
  mappings for machines are in fact mandatory.


  8.  Maintenance

  Keeping it working.


  There is one maintenance task you have to do on nameds, other than
  keeping them running.  That's keeping the root.hints file updated.
  The easiest way is using dig. First run dig with no arguments you will
  get the root.hints according to your own server.  Then ask one of the
  listed root servers with dig @rootserver.  You will note that the
  output looks terribly like a root.hints file.  Save it to a file (dig
  @e.root-servers.net . ns >root.hints.new) and replace the old
  root.hints with it.


  Remember to reload named after replacing the cache file.


  Al Longyear sent me this script that can be run automatically to
  update root.hints.  Install a crontab entry to run it once a month and
  forget it.  The script assumes you have mail working and that the
  mail-alias `hostmaster' is defined.  You must hack it to suit your
  setup.



  ______________________________________________________________________
  #!/bin/sh
  #
  # Update the nameserver cache information file once per month.
  # This is run automatically by a cron entry.
  #
  # Original by Al Longyear
  # Updated for BIND 8 by Nicolai Langfeldt
  # Miscelanious error-conditions reported by David A. Ranch
  # Ping test suggested by Martin Foster
  # named up-test suggested by Erik Bryer.
  #
  (
   echo "To: hostmaster <hostmaster>"
   echo "From: system <root>"

   # Is named up? Check the status of named.
   case `rndc status 2>&1` in
      *refused*)
          echo "named is DOWN. root.hints was NOT updated"
          echo
          exit 0
          ;;
   esac

   PATH=/sbin:/usr/sbin:/bin:/usr/bin:
   export PATH
   # NOTE: /var/named must be writable only by trusted users or this script
   # will cause root compromise/denial of service opportunities.
   cd /var/named 2>/dev/null || {
      echo "Subject: Cannot cd to /var/named, error $?"
      echo
      echo "The subject says it all"
      exit 1
   }

   # Are we online?  Ping a server at your ISP
   case `ping -qnc 1 some.machine.net 2>&1` in
     *'100% packet loss'*)
          echo "Subject: root.hints NOT updated.  The network is DOWN."
          echo
          echo "The subject says it all"
          exit 1
          ;;
   esac

   dig @e.root-servers.net . ns >root.hints.new 2> errors

   case `cat root.hints.new` in
     *NOERROR*)
          # It worked
          :;;
     *)
          echo "Subject: The root.hints file update has FAILED."
          echo
          echo "The root.hints update has failed"
          echo "This is the dig output reported:"
          echo
          cat root.hints.new errors
          exit 1
          ;;
   esac

   echo "Subject: The root.hints file has been updated"
   echo
   echo "The root.hints file has been updated to contain the following
  information:"
   echo
   cat root.hints.new

   chown root.root root.hints.new
   chmod 444 root.hints.new
   rm -f root.hints.old errors
   mv root.hints root.hints.old
   mv root.hints.new root.hints
   rndc restart
   echo
   echo "The nameserver has been restarted to ensure that the update is complete."
   echo "The previous root.hints file is now called
  /var/named/root.hints.old."
  ) 2>&1 | /usr/lib/sendmail -t
  exit 0
  ______________________________________________________________________



  Some of you might have picked up that the root.hints file is also
  available by ftp from Internic.  Please don't use ftp to update
  root.hints, the above method is much more friendly to the net, and
  Internic.


  9.  Migrating to BIND 9

  The BIND 9 distribution, and the prepackaged versions too, contains a
  document called migration that contains notes about how to migrate
  from BIND 8 to BIND 9.  The document is very straight forward.  If you
  installed binary packages it's likely stored in /usr/share/doc/bind*
  or /usr/doc/bind* somewhere.


  If you're running BIND 4, you may find a document called
  migration-4to9 in the same place.


  10.  Questions and Answers

  Please read this section before mailing me.


  1. My named wants a named.boot file


     You are reading the wrong HOWTO.  Please see the old version of
     this HOWTO, which covers BIND 4, at  <http://langfeldt.net/DNS-
     HOWTO/>


  2. How do use DNS from inside a firewall?


     A hint: forward only;.  You might also need


     ___________________________________________________________________
       query-source port 53;

     ___________________________________________________________________



  inside the ``options'' part of the named.conf file as suggested in the
  example ``caching'' section.


  3. How do I make DNS rotate through the available addresses for a
     service, say www.busy.site to obtain a load balancing effect, or
     similar?


     Make several A records for www.busy.site and use BIND 4.9.3 or
     later.  Then BIND will round-robin the answers.  It will not work
     with earlier versions of BIND.


  4. I want to set up DNS on a (closed) intranet.  What do I do?


     You drop the root.hints file and just do zone files.  That also
     means you don't have to get new hint files all the time.


  5. How do I set up a secondary (slave) name server?


     If the primary/master server has address 127.0.0.1 you put a line
     like this in the named.conf file of your secondary:


     ___________________________________________________________________
       zone "linux.bogus" {
             type slave;
             file "sz/linux.bogus";
             masters { 127.0.0.1; };
       };

     ___________________________________________________________________



  You may list several alternate master servers the zone can be copied
  from inside the masters list, separated by ';' (semicolon).


  6. I want BIND running when I'm disconnected from the net.


     There are four items regarding this:


  ·  Specific to BIND 8/9, Adam L Rice has sent me this e-mail, about
     how to run DNS painlessly on a dialup machine:



  I have discovered with newer versions of BIND that this
  [<em/shuffeling files, -ed/] is no longer necessary.  There is a
  "forward" directive in addition to the "forwarders" directive that
  controls how they are used.  The default setting is "forward first",
  which first asks each of the forwarders, and then tries the normal
  approach of doing the legwork itself if that fails.  This gives the
  familiar behaviour of gethostbyname() taking an inordinately long time
  when the link is not up.  But if "forward only" is set, then BIND
  gives up when it doesn't get a response from the forwarders, and
  gethostbyname() returns immediately.  Hence there is no need to
  perform sleight-of-hand with files in /etc and restart the server.

  In my case, I just added the lines

  forward only;
  forwarders { 193.133.58.5; };

  to the options { } section of my named.conf file. It works very
  nicely. The only disadvantage of this is that it reduces an incredibly
  sophisticated piece of DNS software to the status of a dumb cache. To
  some extent, I would just like to run a dumb cache for DNS instead,
  but there doesn't seem to be such a piece of software available for
  Linux.



  ·  I have received this mail from Ian Clark <ic@deakin.edu.au> where
     he explains his way of doing this:



       I run named on my 'Masquerading' machine here. I have
       two root.hints files, one called root.hints.real which contains
       the real root server names and the other called root.hints.fake
       which contains...

       ----
       ; root.hints.fake
       ; this file contains no information
       ----

       When I go off line I copy the root.hints.fake file to root.hints and
       restart named.

       When I go online I copy root.hints.real to root.hints and restart
       named.

       This is done from ip-down & ip-up respectively.

       The first time I do a query off line on a domain name named doesn't
       have details for it puts an entry like this in messages..

       Jan 28 20:10:11 hazchem named[10147]: No root nameserver for class IN

       which I can live with.

       It certainly seems to work for me. I can use the nameserver for
       local machines while off the 'net without the timeout delay for
       external domain names and I while on the 'net queries for external
       domains work normally



  Peter Denison thought that Ian does not go far enough though.  He
  writes:



       When connected) serve all cached (and local network) entries immediately
                       for non-cached entries, forward to my ISPs nameserver
       When off-line)  serve local network queries immediately
                       fail all other queries **immediately**

       The combination of changing the root cache file and forwarding queries
       doesn't work.

       So, I've set up (with some discussion of this on the local LUG) two nameds
       as follows:

       named-online:   forwards to ISPs nameserver
                       master for localnet zone
                       master for localnet reverse zone (1.168.192.in-addr.arpa)
                       master for 0.0.127.in-addr.arpa
                       listens on port 60053

       named-offline:  no forwarding
                       "fake" root cache file
                       slave for 3 local zones (master is 127.0.0.1:60053)
                       listens on port 61053

       And combined this with port forwarding, to send port 53 to 61053 when
       off-line, and to port 60053 when online. (I'm using the new netfilter
       package under 2.3.18, but the old (ipchains) mechanism should work.)

       Note that this won't quite work out-of-the-box, as there's a slight bug in
       BIND 8.2, which I have logged wth the developers, preventing a slave
       having a master on the same IP address (even if a different port). It's a
       trivial patch, and should go in soon I hope.



  ·  I have also received information about how BIND interacts with NFS
     and the portmapper on a mostly offline machine from Karl-Max
     Wanger:



  I use to run my own named on all my machines which are only
  occasionally connected to the Internet by modem. The nameserver only
  acts as a cache, it has no area of authority and asks back for
  everything at the name servers in the root.cache file. As is usual
  with Slackware, it is started before nfsd and mountd.

  With one of my machines (a Libretto 30 notebook) I had the problem
  that sometimes I could mount it from another system connected to my
  local LAN, but most of the time it didn't work.  I had the same effect
  regardless of using PLIP, a PCMCIA ethernet card or PPP over a serial
  interface.

  After some time of guessing and experimenting I found out that
  apparently named messed with the process of registration nfsd and
  mountd have to carry out with the portmapper upon startup (I start
  these daemons at boot time as usual). Starting named after nfsd and
  mountd eliminated this problem completely.

  As there are no disadvantages to expect from such a modified boot
  sequence I'd advise everybody to do it that way to prevent potential
  trouble.



  7. Where does the caching name server store its cache? Is there any
     way I can control the size of the cache?


     The cache is completely stored in memory, it is not written to disk
     at any time.  Every time you kill named the cache is lost.  The
     cache is not controllable in any way.  named manages it according
     to some simple rules and that is it.  You cannot control the cache
     or the cache size in any way for any reason. If you want to you can
     ``fix'' this by hacking named.  This is however not recommended.


  8. Does named save the cache between restarts?  Can I make it save it?


     No, named does not save the cache when it dies.  That means that
     the cache must be built anew each time you kill and restart named.
     There is no way to make named save the cache in a file.  If you
     want you can ``fix'' this by hacking named.  This is however not
     recommended.


  9. How can I get a domain? I want to set up my own domain called (for
     example) linux-rules.net.  How can I get the domain I want assigned
     to me?


     Please contact your network service provider.  They will be able to
     help you with this.  Please note that in most parts of the world
     you need to pay money to get a domain.


  10.
     How can I secure my DNS server?  How do I set up split DNS?


     Both of these are advanced topics.  They are both covered in
     <http://www.etherboy.com/dns/chrootdns.html>.  I will not explain
     the topics further here.
  11.  How to become a bigger time DNS admin.

  Documentation and tools.


  Real Documentation exists.  Online and in print.  The reading of
  several of these is required to make the step from small time DNS
  admin to a big time one.


  I have written The Concise Guide to DNS and BIND (by Nicolai
  Langfeldt, me), published by Que (ISBN 0-7897-2273-9).  The book is
  much like this HOWTO, just more details, and a lot more of everything.
  It has also been translated to Polish and published as DNS i BIND by
  Helion ( <http://helion.pl/ksiazki/dnsbin.htm>, ISBN 83-7197-446-9).
  Now in 4th edition is DNS and BIND by Cricket Liu and P. Albitz from
  O'Reilly & Associates (ISBN 0-937175-82-X, affectionately known as the
  Cricket book).  Another book is Linux DNS Server Administration, by
  Craig Hunt, published by Sybex (ISBN 0782127363), I have not read it
  yet.  Another must for good DNS administration (or good anything for
  that matter) is Zen and the Art of Motorcycle Maintenance by Robert M.
  Pirsig.


  Online you will find my book, along with tons of other books,
  available electronically as a subscription service at
  <http://safari.informit.com/>.  There is stuff on
  <http://www.dns.net/dnsrd/> (DNS Resources Directory),
  <http://www.isc.org/bind.html>; A FAQ, a reference manual (the ARM
  should be enclosed in the BIND distribution as well) as well as papers
  and protocol definitions and DNS hacks (these, and most, if not all,
  of the RFCs mentioned below, are also contained in the BIND
  distribution).  I have not read most of these.  The newsgroup
  <news:comp.protocols.tcp-ip.domains> is about DNS.  In addition there
  are a number of RFCs about DNS, the most important are probably the
  ones listed here.  Those that have BCP (Best Current Practice) numbers
  are highly recommended.



     RFC 2671
        P. Vixie, Extension Mechanisms for DNS (EDNS0) August 1999.


     RFC 2317
        BCP 20, H. Eidnes et. al. Classless IN-ADDR.ARPA delegation,
        March 1998. This is about CIDR, or classless subnet reverse
        lookups.


     RFC 2308
        M. Andrews, Negative Caching of DNS Queries, March 1998.  About
        negative caching and the $TTL zone file directive.


     RFC 2219
        BCP 17, M. Hamilton and R. Wright, Use of DNS Aliases for
        Network Services, October 1997.  About CNAME usage.


     RFC 2182
        BCP 16, R. Elz et. al., Selection and Operation of Secondary DNS
        Servers, July 1997.



     RFC 2052
        A. Gulbrandsen, P. Vixie, A DNS RR for specifying the location
        of services (DNS SRV), October 1996


     RFC 1918
        Y. Rekhter, R. Moskowitz, D. Karrenberg, G. de Groot, E. Lear,
        Address Allocation for Private Internets, 02/29/1996.


     RFC 1912
        D. Barr, Common DNS Operational and Configuration Errors,
        02/28/1996.


     RFC 1912 Errors
        B. Barr Errors in RFC 1912.  Only available at
        <http://www.cis.ohio-state.edu/~barr/rfc1912-errors.html>


     RFC 1713
        A. Romao, Tools for DNS debugging, 11/03/1994.


     RFC 1712
        C. Farrell, M. Schulze, S. Pleitner, D. Baldoni, DNS Encoding of
        Geographical Location, 11/01/1994.


     RFC 1183
        R. Ullmann, P. Mockapetris, L. Mamakos, C. Everhart, New DNS RR
        Definitions, 10/08/1990.


     RFC 1035
        P. Mockapetris, Domain names - implementation and specification,
        11/01/1987.


     RFC 1034
        P. Mockapetris, Domain names - concepts and facilities,
        11/01/1987.


     RFC 1033
        M. Lottor, Domain administrators operations guide, 11/01/1987.


     RFC 1032
        M. Stahl, Domain administrators guide, 11/01/1987.


     RFC 974
        C. Partridge, Mail routing and the domain system, 01/01/1986.

</sect1>
